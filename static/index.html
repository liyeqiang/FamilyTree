<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self';">
    <title>ÂÆ∂ÊóèÊ†ëÁÆ°ÁêÜÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 1.8em;
            font-weight: 600;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: white;
        }

        .search-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #4CAF50;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background: #45a049;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        /* Áî®Êà∑‰ø°ÊÅØÂå∫ÂüüÊ†∑Âºè */
        .user-info-section {
            display: flex;
            align-items: center;
        }

        .user-info-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-greeting {
            color: #333;
            font-weight: 500;
            font-size: 14px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .family-tree-main {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tree-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        .tree-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .generations-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
        }

        .add-root-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-root-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .tree-container {
            background: #fafafa;
            border-radius: 10px;
            padding: 30px;
            overflow: auto;
            min-height: 500px;
            position: relative;
        }

        .tree-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 20px;
            min-height: 100vh;
            overflow-x: auto;
            position: relative;
        }

        .tree-generation {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            min-height: 120px;
            width: 100%;
            position: relative;
            z-index: 2;
        }

        /* SVGËøûÊé•Á∫øÊ†∑Âºè */
        .tree-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* ËøûÊé•Á∫øÈ¢úËâ≤ */
        .connection-line {
            stroke: #4CAF50;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .connection-line.parent-child {
            stroke: #2196F3;
            stroke-width: 2.5;
        }

        .connection-line.spouse {
            stroke: #E91E63;
            stroke-width: 2;
        }

        .connection-line.sibling {
            stroke: #FF9800;
            stroke-width: 2;
        }

        /* ËôöÁ∫øÊ†∑Âºè */
        .connection-line[stroke-dasharray] {
            stroke-opacity: 0.7;
        }

        .tree-connector {
            width: 3px;
            height: 40px;
            background: transparent;
            margin: 0 auto;
        }

        .tree-node {
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            padding: 15px;
            min-width: 140px;
            max-width: 200px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        /* Á¥ßÂáëÊ®°Âºè - Âè™ÊòæÁ§∫ÂßìÂêç */
        .tree-node.compact {
            padding: 10px;
            min-width: 100px;
            max-width: 120px;
            font-size: 0.9em;
        }

        .tree-node.compact .node-details,
        .tree-node.compact .node-occupation {
            display: none;
        }

        .tree-node:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tree-node.selected {
            background: #4CAF50;
            color: white;
            transform: scale(1.05);
        }

        .ancestor-node {
            border-color: #607D8B;
            background: #eceff1;
        }

        .root-node {
            border-color: #2196F3;
            background: #e3f2fd;
            border-width: 4px;
            transform: scale(1.05);
        }

        .spouse-node {
            border-color: #E91E63;
            background: #fce4ec;
        }

        .child-node {
            border-color: #FF9800;
            background: #fff3e0;
        }

        .descendant-node {
            border-color: #9C27B0;
            background: #f3e5f5;
        }

        .node-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .node-details {
            font-size: 0.8em;
            color: #666;
            margin: 3px 0;
            line-height: 1.3;
        }

        .node-occupation {
            font-size: 0.75em;
            color: #888;
            font-style: italic;
            margin-top: 5px;
        }

        .marriage-connector {
            display: flex;
            align-items: center;
            font-size: 1.5em;
            margin: 0;
            color: #E91E63;
            flex-shrink: 0;
        }

        .family-group {
            display: flex;
            align-items: center;
            margin: 0 5px;
            flex-wrap: nowrap;
        }

        /* Â§öÂ¶ªÂ≠êÊòæÁ§∫Ê†∑Âºè */
        .spouses-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .spouse-separator {
            color: #ccc;
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 5px;
        }

        /* ÊîπËøõÁöÑËøûÊé•Á∫øÊ†∑Âºè */
        .generation-with-connections {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .connection-lines {
            position: relative;
            width: 100%;
            height: 40px;
            margin-bottom: 10px;
        }

        .horizontal-line {
            position: absolute;
            height: 2px;
            background: #4CAF50;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-line {
            position: absolute;
            width: 2px;
            background: #4CAF50;
            top: 0;
            height: 100%;
        }

        .children-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
        }

        .child-with-mother-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mother-indicator {
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 2px solid;
            background: white;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .mothers-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mother-info {
            font-size: 0.7em;
            font-weight: bold;
            margin-top: 5px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            text-align: center;
            border: 1px solid;
        }

        .tree-node.compact .mother-info {
            font-size: 0.6em;
            padding: 1px 4px;
        }

        /* SVGËøûÊé•Á∫øÊ†∑Âºè */
        .tree-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .tree-generation {
            position: relative;
            z-index: 2;
        }

        .tree-wrapper {
            position: relative;
        }

        /* ËøûÊé•Á∫øÈ¢úËâ≤ */
        .connection-line {
            stroke: #4CAF50;
            stroke-width: 2;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .connection-line.parent-child {
            stroke: #2196F3;
            stroke-width: 2.5;
        }

        .connection-line.spouse {
            stroke: #E91E63;
            stroke-width: 2;
        }

        .connection-line.sibling {
            stroke: #FF9800;
            stroke-width: 2;
        }

        /* ËôöÁ∫øÊ†∑Âºè */
        .connection-line[stroke-dasharray] {
            stroke-opacity: 0.7;
        }

        .tree-connector {
            width: 3px;
            height: 40px;
            background: transparent;
            margin: 0 auto;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .tree-node {
                min-width: 120px;
                max-width: 150px;
                padding: 12px;
            }
            
            .tree-node.compact {
                min-width: 90px;
                max-width: 110px;
                padding: 8px;
            }
            
            .marriage-connector {
                font-size: 1.2em;
                margin: 0;
            }
        }

        @media (max-width: 768px) {
            .tree-generation {
                gap: 10px;
            }
            
            .tree-node {
                min-width: 100px;
                max-width: 130px;
                padding: 10px;
                font-size: 0.9em;
            }
            
            .tree-node.compact {
                min-width: 80px;
                max-width: 100px;
                padding: 6px;
                font-size: 0.8em;
            }
        }

        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            padding: 6px 0;
            z-index: 3000;
            display: none;
            min-width: 200px;
            max-width: 250px;
            border: 2px solid #e0e0e0;
            max-height: 350px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            width: 100%;
            border: none;
            background: none;
            text-align: left;
            color: #333;
            line-height: 1.4;
            min-height: 44px;
            box-sizing: border-box;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .context-menu-item:hover {
            background: #f8f9fa;
            color: #333;
            transform: translateX(2px);
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
            color: #d32f2f;
            transform: translateX(2px);
        }

        .context-menu-item:active {
            background: #e9ecef !important;
            transform: translateX(0px) !important;
            color: #333 !important;
        }

        .context-menu-item.danger:active {
            background: #ffcdd2 !important;
            color: #d32f2f !important;
        }

        .context-menu-item:focus {
            outline: 2px solid #4CAF50;
            outline-offset: -2px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            background: #4CAF50;
        }

        .notification.error {
            background: #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        /* ÊàêÂëòËØ¶ÊÉÖÊ†∑Âºè */
        .member-details {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section h3 {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
            font-size: 1.1em;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .detail-item label {
            font-weight: 600;
            color: #555;
            min-width: 80px;
            margin-right: 10px;
        }

        .detail-item span {
            color: #333;
            flex: 1;
        }

        .notes-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            line-height: 1.6;
            color: #333;
        }

        .detail-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .detail-actions .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-actions .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .detail-actions .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .detail-actions .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .detail-actions .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* ‰º†ÁªüÊóèË∞±Â∏ÉÂ±ÄÊ†∑Âºè */
        .traditional-family-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            position: relative;
        }

        .parents-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .children-connection-area {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-vertical-line {
            width: 3px;
            height: 40px;
            background: #4CAF50;
            margin: 0 auto;
            position: relative;
        }

        .horizontal-connector {
            width: 100%;
            height: 3px;
            background: #4CAF50;
            position: relative;
            margin: 0 auto;
        }

        .children-with-lines {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            position: relative;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .child-with-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .child-vertical-line {
            width: 3px;
            height: 30px;
            background: #4CAF50;
            margin-bottom: 10px;
        }

        .child-order-label {
            font-size: 0.7em;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
            padding: 2px 6px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .birth-order-indicator {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            font-weight: bold;
            color: #2196F3;
            background: white;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #2196F3;
            white-space: nowrap;
        }

        /* ËøûÊé•Á∫øËÆ°ÁÆó */
        .children-connector-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            pointer-events: none;
        }

        .horizontal-line-segment {
            position: absolute;
            height: 3px;
            background: #4CAF50;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-line-segment {
            position: absolute;
            width: 3px;
            background: #4CAF50;
            top: 0;
            height: 100%;
        }

        /* Â¶ªÂ≠êÂàÜÁªÑÊòæÁ§∫ */
        .wives-groups-layout {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
        }

        .wife-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid #e8f4f8;
            border-radius: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fdff 0%, #f0f9ff 100%);
            position: relative;
        }

        .wife-group-header {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
            padding: 8px 15px;
            background: white;
            border-radius: 20px;
            border: 2px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .wife-children-traditional {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            width: 100%;
        }

        /* Êñ∞Áî®Êà∑Ê¨¢ËøéÁïåÈù¢Ê†∑Âºè */
        .new-user-welcome {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, #f8fdff 0%, #f0f9ff 100%);
            border-radius: 15px;
            border: 2px solid #e3f2fd;
        }

        .welcome-icon {
            font-size: 4em;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .new-user-welcome h2 {
            color: #2c5aa0;
            font-size: 2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .new-user-welcome p {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .welcome-steps {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            max-width: 200px;
            text-align: left;
        }

        .step-number {
            background: #4CAF50;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .step-content h3 {
            color: #333;
            font-size: 1em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .step-content p {
            color: #666;
            font-size: 0.85em;
            line-height: 1.4;
            margin: 0;
        }

        .welcome-actions {
            margin-top: 20px;
        }

        .btn-large {
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            transition: all 0.3s;
        }

        .btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-icon {
            margin-right: 8px;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .welcome-steps {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .step {
                max-width: 300px;
                text-align: center;
                flex-direction: column;
                align-items: center;
            }
            
            .step-content {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>üå≥ ÂÆ∂ÊóèÊ†ë</h1>
            </div>
            
            <!-- ÊêúÁ¥¢Ê°Ü -->
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢ÂÆ∂ÊóèÊàêÂëò...">
                <button class="search-btn" id="searchBtn">üîç</button>
                <div class="search-results" id="searchResults"></div>
            </div>
            
            <!-- Áî®Êà∑‰ø°ÊÅØÂå∫Âüü -->
            <div class="user-info-section" id="userInfoSection" style="display: none;">
                <div class="user-info-content">
                    <span class="user-greeting">üëã Ê¨¢ËøéÔºå<span id="currentUserName"></span></span>
                    <button class="logout-btn" id="logoutBtn">ÈÄÄÂá∫ÁôªÂΩï</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-container">
        <div class="family-tree-main">
            <div class="tree-header">
                <div class="tree-title">
                    <span id="currentRootName">ÂÆ∂ÊóèÊ†ë</span>
                    <span id="currentGenInfo" style="font-size: 0.7em; color: #666; margin-left: 10px;"></span>
                </div>
                <div class="tree-controls">
                    <button onclick="showFamilyTree(currentRootId)" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Âà∑Êñ∞
                    </button>
                    <select id="generationSelect" onchange="changeGenerations()" class="form-control" style="width: auto; display: inline-block;">
                        <option value="2">ÊòæÁ§∫2‰ª£</option>
                        <option value="3" selected>ÊòæÁ§∫3‰ª£</option>
                        <option value="4">ÊòæÁ§∫4‰ª£</option>
                        <option value="5">ÊòæÁ§∫5‰ª£</option>
                    </select>
                </div>
            </div>
            
            <!-- ÊóèË∞±ÊòæÁ§∫Âå∫Âüü -->
            <div class="tree-container" id="treeContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">üå±</div>
                    <div class="empty-state-text">ÂºÄÂßãÊûÑÂª∫ÊÇ®ÁöÑÂÆ∂ÊóèÊ†ë</div>
                    <button class="btn btn-primary" onclick="showAddModal()">Ê∑ªÂä†Á¨¨‰∏Ä‰ΩçÊàêÂëò</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Âè≥ÈîÆËèúÂçï -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" data-action="addChild">üë∂ Ê∑ªÂä†Â≠êÂ•≥</div>
        <div class="context-menu-item" data-action="addSpouse">üíë Ê∑ªÂä†ÈÖçÂÅ∂</div>
        <div class="context-menu-item" data-action="addFather">üë® Ê∑ªÂä†Áà∂‰∫≤</div>
        <div class="context-menu-item" data-action="addMother">üë© Ê∑ªÂä†ÊØç‰∫≤</div>
        <div class="context-menu-item" data-action="viewDetails">üìã Êü•ÁúãËØ¶ÊÉÖ</div>
        <div class="context-menu-item" data-action="editMember">‚úèÔ∏è ÁºñËæë‰ø°ÊÅØ</div>
        <div class="context-menu-item danger" data-action="deleteMember">üóëÔ∏è Âà†Èô§ÊàêÂëò</div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëÊàêÂëòÊ®°ÊÄÅÊ°Ü -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Ê∑ªÂä†ÊàêÂëò</div>
                <span class="close" id="closeMemberModalBtn">&times;</span>
            </div>
            
            <form id="memberForm">
                <input type="hidden" id="editingId" value="">
                <input type="hidden" id="parentType" value="">
                
                <div class="form-group">
                    <label for="fullName">ÂßìÂêç *</label>
                    <input type="text" id="fullName" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">ÊÄßÂà´ *</label>
                    <select id="gender" required>
                        <option value="">ËØ∑ÈÄâÊã©ÊÄßÂà´</option>
                        <option value="male">Áî∑</option>
                        <option value="female">Â•≥</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birthDate">Âá∫ÁîüÊó•Êúü</label>
                    <input type="date" id="birthDate">
                </div>
                
                <div class="form-group">
                    <label for="birthPlace">Âá∫ÁîüÂú∞ÁÇπ</label>
                    <input type="text" id="birthPlace" placeholder="Â¶ÇÔºöÂåó‰∫¨Â∏ÇÊúùÈò≥Âå∫">
                </div>
                
                <div class="form-group">
                    <label for="deathDate">Âéª‰∏ñÊó•Êúü</label>
                    <input type="date" id="deathDate">
                </div>
                
                <div class="form-group">
                    <label for="burialPlace">ÂüãËë¨Âú∞ÁÇπ</label>
                    <input type="text" id="burialPlace" placeholder="Â¶ÇÔºöÂåó‰∫¨Â∏ÇÊòåÂπ≥Âå∫Â¢ìÂõ≠">
                </div>
                
                <div class="form-group">
                    <label for="occupation">ËÅå‰∏ö</label>
                    <input type="text" id="occupation">
                </div>
                
                <div class="form-group">
                    <label for="notes">Â§áÊ≥®</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                
                <!-- ÊØç‰∫≤ÈÄâÊã©ÁªÑ -->
                <div class="form-group" id="wifeSelectionGroup" style="display: none;">
                    <label for="selectedWife">ÈÄâÊã©ÊØç‰∫≤:</label>
                    <select id="selectedWife" name="selectedWife">
                        <option value="">ËØ∑ÈÄâÊã©ÊØç‰∫≤</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelMemberModalBtn">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Êü•ÁúãËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ÊàêÂëòËØ¶ÊÉÖ</div>
                <span class="close" id="closeDetailsModalBtn">&times;</span>
            </div>
            <div id="detailsContent"></div>
        </div>
    </div>

    <!-- ÈÄöÁü•ÁªÑ‰ª∂ -->
    <div id="notification" class="notification"></div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let allMembers = [];
        let currentRootId = null;
        let currentGenerations = 3;
        let selectedNodeId = null;
        let contextMenuNode = null;
        let currentToken = null;
        let currentUser = null;

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeAuth();
        });

        // ÂàùÂßãÂåñËÆ§ËØÅ
        async function initializeAuth() {
            // Ê£ÄÊü•Êú¨Âú∞Â≠òÂÇ®‰∏≠ÁöÑtoken
            currentToken = localStorage.getItem('authToken');
            
            if (!currentToken) {
                // Ê≤°ÊúâtokenÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = '/static/login.html';
                return;
            }

            try {
                // È™åËØÅtokenÂπ∂Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
                const response = await fetch('/api/v1/user/validate', {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    // tokenÊó†ÊïàÔºåÊ∏ÖÈô§Âπ∂Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/login.html';
                    return;
                }

                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.data.user;  // Ê≥®ÊÑèËøôÈáåÁöÑÊï∞ÊçÆÁªìÊûÑ
                    displayUserInfo();
                    loadAllMembers();
                    initializeEventListeners();
                } else {
                    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•ÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                    localStorage.removeItem('authToken');
                    window.location.href = '/static/login.html';
                }
            } catch (error) {
                console.error('ËÆ§ËØÅÂ§±Ë¥•:', error);
                localStorage.removeItem('authToken');
                window.location.href = '/static/login.html';
            }
        }

        // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØ
        function displayUserInfo() {
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.full_name || currentUser.username;
                document.getElementById('userInfoSection').style.display = 'block';
            }
        }

        // ÈÄÄÂá∫ÁôªÂΩï
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/static/login.html';
        }

        // Â∏¶ËÆ§ËØÅÁöÑfetchÂáΩÊï∞
        async function authenticatedFetch(url, options = {}) {
            const defaultHeaders = {
                'Authorization': `Bearer ${currentToken}`,
                'Content-Type': 'application/json'
            };

            const mergedOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers
                }
            };

            const response = await fetch(url, mergedOptions);
            
            // Â¶ÇÊûúËøîÂõû401ÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
            if (response.status === 401) {
                localStorage.removeItem('authToken');
                window.location.href = '/static/login.html';
                return;
            }

            return response;
        }

        // ÂàùÂßãÂåñ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function initializeEventListeners() {
            // ÊêúÁ¥¢Ê°Ü‰∫ã‰ª∂
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('searchInput').addEventListener('focus', handleSearchFocus);
            document.getElementById('searchInput').addEventListener('blur', handleSearchBlur);
            
            // Áªü‰∏ÄÁöÑÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
            document.addEventListener('click', async function(e) {
                // Â§ÑÁêÜÂè≥ÈîÆËèúÂçïÈ°πÁÇπÂáª
                if (e.target.closest('.context-menu-item')) {
                    const menuItem = e.target.closest('.context-menu-item');
                    const action = menuItem.dataset.action;
                    console.log('Âè≥ÈîÆËèúÂçïÈ°πË¢´ÁÇπÂáªÔºåÂä®‰Ωú:', action, 'contextMenuNode:', contextMenuNode);
                    
                    // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
                    e.stopPropagation();
                    e.preventDefault();
                    
                    // ÊâßË°åÂØπÂ∫îÁöÑÂä®‰Ωú
                    try {
                        switch(action) {
                            case 'addChild':
                                console.log('ÂáÜÂ§áË∞ÉÁî® showAddChildModal()');
                                showAddChildModal();
                                break;
                            case 'addSpouse':
                                console.log('ÂáÜÂ§áË∞ÉÁî® showAddSpouseModal()');
                                showAddSpouseModal();
                                break;
                            case 'addFather':
                                console.log('ÂáÜÂ§áË∞ÉÁî® showAddFatherModal()');
                                await showAddFatherModal();
                                break;
                            case 'addMother':
                                console.log('ÂáÜÂ§áË∞ÉÁî® showAddMotherModal()');
                                await showAddMotherModal();
                                break;
                            case 'viewDetails':
                                console.log('ÂáÜÂ§áË∞ÉÁî® showViewDetailsModal()');
                                await showViewDetailsModal();
                                break;
                            case 'editMember':
                                console.log('ÂáÜÂ§áË∞ÉÁî® editSelectedMember()');
                                await editSelectedMember();
                                break;
                            case 'deleteMember':
                                console.log('ÂáÜÂ§áË∞ÉÁî® deleteSelectedMember()');
                                await deleteSelectedMember();
                                break;
                            default:
                                console.error('Êú™Áü•ÁöÑËèúÂçïÂä®‰Ωú:', action);
                        }
                    } catch (error) {
                        console.error('ÊâßË°åËèúÂçïÂä®‰ΩúÊó∂ÂèëÁîüÈîôËØØ:', error);
                        console.error('Âä®‰Ωú:', action);
                        console.error('contextMenuNode:', contextMenuNode);
                    }
                    return;
                }
                
                // Â§ÑÁêÜÊ†ëËäÇÁÇπÁÇπÂáªÔºàÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØÔºâ
                if (e.target.closest('.tree-node')) {
                    const nodeElement = e.target.closest('.tree-node');
                    if (nodeElement && nodeElement.dataset && nodeElement.dataset.id) {
                        const nodeId = parseInt(nodeElement.dataset.id);
                        console.log('Â∑¶ÈîÆÁÇπÂáª‰∫ã‰ª∂ÔºöËé∑ÂèñÂà∞ËäÇÁÇπID:', nodeId);
                        selectNode(nodeId);
                    } else {
                        console.error('Â∑¶ÈîÆÁÇπÂáª‰∫ã‰ª∂ÔºöÊó†Ê≥ïËé∑ÂèñËäÇÁÇπID', nodeElement);
                    }
                    return; // ÈòªÊ≠¢ÂêéÁª≠Â§ÑÁêÜ
                }
            
            // Â§ÑÁêÜÊêúÁ¥¢ÁªìÊûúÁÇπÂáª
                if (e.target.closest('.search-result-item')) {
                    const resultItem = e.target.closest('.search-result-item');
                    const memberId = parseInt(resultItem.dataset.memberId);
                    if (memberId) {
                        selectSearchResult(memberId);
                    }
                    return;
                }

                // ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂÖ≥Èó≠ÊêúÁ¥¢ÁªìÊûúÂíåÂè≥ÈîÆËèúÂçï
                if (!e.target.closest('.search-container')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
                if (!e.target.closest('.context-menu')) {
                    document.getElementById('contextMenu').style.display = 'none';
                }
            });

            // Âè≥ÈîÆËèúÂçï‰∫ã‰ª∂
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.tree-node')) {
                    e.preventDefault();
                    // ÈÄöËøáDOMÂÖÉÁ¥†Â§ÑÁêÜÂè≥ÈîÆ‰∫ã‰ª∂
                    const nodeElement = e.target.closest('.tree-node');
                    if (nodeElement && nodeElement.dataset && nodeElement.dataset.id) {
                        const nodeId = parseInt(nodeElement.dataset.id);
                        console.log('Âè≥ÈîÆ‰∫ã‰ª∂ÔºöËé∑ÂèñÂà∞ËäÇÁÇπID:', nodeId);
                        showContextMenu(e, nodeId);
                    } else {
                        console.error('Âè≥ÈîÆ‰∫ã‰ª∂ÔºöÊó†Ê≥ïËé∑ÂèñËäÇÁÇπID', nodeElement);
                    }
                }
            });

            // Ë°®ÂçïÊèê‰∫§‰∫ã‰ª∂
            document.getElementById('memberForm').addEventListener('submit', handleFormSubmit);

            // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®‰øÆÂ§çCSPÈóÆÈ¢ò
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('closeMemberModalBtn').addEventListener('click', closeMemberModal);
            document.getElementById('cancelMemberModalBtn').addEventListener('click', closeMemberModal);
            document.getElementById('closeDetailsModalBtn').addEventListener('click', closeDetailsModal);
        }

        // Âä†ËΩΩÊâÄÊúâÊàêÂëòÊï∞ÊçÆ
        async function loadAllMembers() {
            try {
                // Ê∑ªÂä†Êó∂Èó¥Êà≥ÂèÇÊï∞ÈÅøÂÖçÁºìÂ≠ò
                const timestamp = new Date().getTime();
                const response = await authenticatedFetch(`/api/v1/individuals?_=${timestamp}`, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    allMembers = data.data || [];
                    if (allMembers.length > 0) {
                        // Ê£ÄÊü•ÊòØÂê¶ÊúâÊùéÂØåË¥µ(ID:12)Ôºå‰ºòÂÖàÊòæÁ§∫‰∏ÄÂ§´Â§öÂ¶ªÁöÑÊºîÁ§∫
                        const polygamyDemo = allMembers.find(m => m.individual_id === 12);
                        const defaultId = polygamyDemo ? 12 : allMembers[0].individual_id;
                        showFamilyTree(defaultId);
                        
                        // Â¶ÇÊûúÊòæÁ§∫ÊùéÂØåË¥µÔºåÊèêÁ§∫Áî®Êà∑ËøôÊòØ‰∏ÄÂ§´Â§öÂ¶ªÊºîÁ§∫
                        if (polygamyDemo && defaultId === 12) {
                            setTimeout(() => {
                                showNotification('üéØ Ê≠£Âú®ÊòæÁ§∫ÊùéÂØåË¥µÁöÑ‰∏ÄÂ§´Â§öÂ¶ªÂÆ∂ÊóèÊ†ëÊºîÁ§∫', 'success');
                            }, 1000);
                        }
                    } else {
                        // Êñ∞Áî®Êà∑Ê≤°ÊúâÊï∞ÊçÆÔºåÊòæÁ§∫Ê¨¢ËøéÁïåÈù¢
                        showNewUserWelcome();
                    }
                } else {
                    showNotification('Âä†ËΩΩÊàêÂëòÊï∞ÊçÆÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊàêÂëòÊï∞ÊçÆÂ§±Ë¥•:', error);
                showNotification('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // ÊêúÁ¥¢Â§ÑÁêÜ
        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 1) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            const results = allMembers.filter(member => 
                member.full_name.includes(query) || 
                (member.notes && member.notes.includes(query)) ||
                (member.occupation && member.occupation.includes(query))
            );

            displaySearchResults(results);
        }

        // ÊòæÁ§∫ÊêúÁ¥¢ÁªìÊûú
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊàêÂëò</div>';
            } else {
                container.innerHTML = results.map(member => `
                    <div class="search-result-item ${member.individual_id === 12 ? 'polygamy-demo' : ''}" data-member-id="${member.individual_id}">
                        <strong>${member.full_name}${member.individual_id === 12 ? ' üî•‰∏ÄÂ§´Â§öÂ¶ªÊºîÁ§∫' : ''}</strong>
                        <div style="font-size: 0.85em; color: #666;">
                            ${member.gender === 'male' ? '‚ôÇ' : '‚ôÄ'} 
                            ${member.occupation || ''} 
                            ${member.birth_date ? formatDate(member.birth_date) : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            container.style.display = 'block';
        }

        // ÈÄâÊã©ÊêúÁ¥¢ÁªìÊûú
        function selectSearchResult(memberId) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
            showFamilyTree(memberId);
        }

        // ÊêúÁ¥¢Ê°ÜÁÑ¶ÁÇπ‰∫ã‰ª∂
        function handleSearchFocus() {
            if (allMembers.length > 0) {
                displaySearchResults(allMembers.slice(0, 5)); // ÊòæÁ§∫Ââç5‰∏™ÊàêÂëò
            }
        }

        // ÊêúÁ¥¢Ê°ÜÂ§±ÁÑ¶‰∫ã‰ª∂
        function handleSearchBlur() {
            setTimeout(() => {
                document.getElementById('searchResults').style.display = 'none';
            }, 200);
        }

        // ÊâßË°åÊêúÁ¥¢
        function performSearch() {
            handleSearch();
        }



        // ÊòæÁ§∫ÂÆ∂ÊóèÊ†ë
        async function showFamilyTree(rootId) {
            if (!rootId) return;
            
            currentRootId = rootId;
            
            try {
                // Ëé∑ÂèñÂÆ∂ÊóèÊ†ëÊï∞ÊçÆÔºåÊ∑ªÂä†Êó∂Èó¥Êà≥ÈÅøÂÖçÁºìÂ≠ò
                const timestamp = new Date().getTime();
                const response = await authenticatedFetch(`/api/v1/individuals/${rootId}/family-tree?generations=${currentGenerations}&_=${timestamp}`, {
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                });
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Ëé∑ÂèñÁà∂ÊØçÂíåÈÖçÂÅ∂‰ø°ÊÅØÔºåÊ∑ªÂä†Êó∂Èó¥Êà≥ÈÅøÂÖçÁºìÂ≠ò
                    const [parentsRes, spousesRes] = await Promise.all([
                        authenticatedFetch(`/api/v1/individuals/${rootId}/parents?_=${timestamp}`, {
                            headers: {
                                'Cache-Control': 'no-cache', 
                                'Pragma': 'no-cache'
                            }
                        }),
                        authenticatedFetch(`/api/v1/individuals/${rootId}/spouses?_=${timestamp}`, {
                            headers: {
                                'Cache-Control': 'no-cache', 
                                'Pragma': 'no-cache'
                            }
                        })
                    ]);
                    
                    const [parentsData, spousesData] = await Promise.all([
                        parentsRes.json(),
                        spousesRes.json()
                    ]);
                    
                    const enrichedData = {
                        ...data.data,
                        parents: parentsData.success ? parentsData.data : [],
                        spouses: spousesData.success ? spousesData.data : []
                    };
                    
                    console.log('ÂÆ∂ÊóèÊ†ëÊï∞ÊçÆ:', enrichedData);
                    console.log('ÈÖçÂÅ∂Êï∞ÊçÆ:', spousesData);
                    
                    await displayFamilyTree(enrichedData);
                    updateTreeHeader(data.data.individual);
                } else {
                    showNotification('Êó†Ê≥ïÂä†ËΩΩÂÆ∂ÊóèÊ†ëÊï∞ÊçÆ', 'error');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂÆ∂ÊóèÊ†ëÂ§±Ë¥•:', error);
                showNotification('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }

        // Ê∏≤ÊüìÂÆ∂ÊóèÊ†ë
        async function displayFamilyTree(treeData) {
            const container = document.getElementById('treeContainer');
                container.innerHTML = await renderFamilyTree(treeData);
        }

        // Ê∏≤ÊüìÂÆ∂ÊóèÊ†ë
        async function renderFamilyTree(rootData) {
            if (!rootData || !rootData.individual) {
                return '<div class="empty-state"><div class="empty-state-icon">üå±</div><div class="empty-state-text">ÊöÇÊó†Êï∞ÊçÆ</div></div>';
            }
            
            // ÊûÑÂª∫ÂÆåÊï¥ÁöÑÂÆ∂ÊóèÊ†ëÊï∞ÊçÆÁªìÊûÑ
            const treeStructure = await buildTreeStructure(rootData);
            
            let html = '<div class="tree-wrapper">';
            html += '<svg class="tree-connections" id="treeConnections"></svg>';
            
            // ÊåâÂ±ÇÁ∫ßÊ∏≤Êüì
            for (let level = 0; level < treeStructure.levels.length; level++) {
                const levelData = treeStructure.levels[level];
                if (levelData.members.length === 0) continue;
                
                const shouldUseCompact = levelData.members.length > 6;
                
                html += `<div class="tree-generation" data-level="${level}">`;
                
                for (let i = 0; i < levelData.members.length; i++) {
                    const member = levelData.members[i];
                    const nodeClass = getNodeClass(member, level, treeStructure.rootLevel);
                    const label = getNodeLabel(member, level, treeStructure.rootLevel);
                    
                    html += renderTreeNode(member.individual, nodeClass, label, shouldUseCompact);
                    
                    // Â¶ÇÊûú‰∏ã‰∏Ä‰∏™ÊàêÂëòÊòØÈÖçÂÅ∂ÔºåÂú®ÂΩìÂâçËäÇÁÇπÂêéÈù¢Ê∑ªÂä†ËøûÊé•Âô®
                    const nextMember = levelData.members[i + 1];
                    if (nextMember && nextMember.isSpouse) {
                        html += '<div class="marriage-connector">üíï</div>';
                    }
                }
                
                html += '</div>';
                
                // Ê∑ªÂä†Â±ÇÁ∫ßÈó¥ÁöÑËøûÊé•Âô®
                if (level < treeStructure.levels.length - 1) {
                    html += '<div class="tree-connector"></div>';
                }
            }
            
            html += '</div>';
            
            // Ê∏≤ÊüìÂÆåÊàêÂêéÁªòÂà∂ËøûÊé•Á∫ø
            setTimeout(() => drawConnections(treeStructure), 100);
            
            return html;
        }

        // ÊûÑÂª∫Ê†ëÁªìÊûÑ
        async function buildTreeStructure(rootData) {
            const levels = [];
            const rootLevel = 1; // Ê†πËäÇÁÇπÂú®Á¨¨1Â±Ç
            
            // Á¨¨0Â±ÇÔºöÁà∂ÊØçÔºàÂè™ÊúâÂú®‰ª£Êï∞ËÆæÁΩÆÂÖÅËÆ∏Êó∂ÊâçÊòæÁ§∫Ôºâ
            if (rootData.parents && rootData.parents.length > 0 && currentGenerations > 1) {
                const parentMembers = [];
                const processedParents = new Set();
                
                for (const parent of rootData.parents) {
                    if (processedParents.has(parent.individual_id)) {
                        continue; // Ë∑≥ËøáÂ∑≤Â§ÑÁêÜÁöÑÁà∂ÊØç
                    }
                    
                    // Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Áà∂ÊØçÔºàÈÄöÂ∏∏ÊòØÁà∂‰∫≤Ôºâ
                    parentMembers.push({
                        individual: parent,
                        isSpouse: false,
                        generation: -1
                    });
                    processedParents.add(parent.individual_id);
                    
                    // Ëé∑ÂèñÁà∂ÊØçÁöÑÈÖçÂÅ∂
                    try {
                        const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${parent.individual_id}/spouses?_=${Date.now()}`, {
                            headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                        });
                        const spousesData = await spousesResponse.json();
                        
                        if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                            spousesData.data.forEach(spouse => {
                                if (!processedParents.has(spouse.individual_id)) {
                                    parentMembers.push({
                                        individual: spouse,
                                        isSpouse: true,
                                        generation: -1
                                    });
                                    processedParents.add(spouse.individual_id);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Ëé∑ÂèñÁà∂ÊØçÈÖçÂÅ∂‰ø°ÊÅØÂ§±Ë¥•:', error);
                    }
                }
                levels.push({ members: parentMembers, generation: -1 });
            }
            
            // Á¨¨1Â±ÇÔºöÊ†πËäÇÁÇπÂíåÈÖçÂÅ∂ÔºàÂßãÁªàÊòæÁ§∫Ôºâ
            const rootMembers = [{
                individual: rootData.individual,
                isSpouse: false,
                generation: 0
            }];
            
            if (rootData.spouses && rootData.spouses.length > 0) {
                rootData.spouses.forEach(spouse => {
                    rootMembers.push({
                        individual: spouse,
                        isSpouse: true,
                        generation: 0
                    });
                });
            }
            levels.push({ members: rootMembers, generation: 0 });
            
            // ÂêéÁª≠Â±ÇÁ∫ßÔºöÊåâ‰ª£Êï∞Êî∂ÈõÜÊâÄÊúâÂêé‰ª£ÔºàÂè™ÊúâÂú®‰ª£Êï∞ËÆæÁΩÆÂÖÅËÆ∏Êó∂ÊâçÊî∂ÈõÜÔºâ
            if (currentGenerations > 1) {
                await collectDescendantsByGeneration(rootData, levels, 1);
            }
            
            return { levels, rootLevel };
        }

        // Êåâ‰ª£Êï∞Êî∂ÈõÜÂêé‰ª£
        async function collectDescendantsByGeneration(parentData, levels, generation) {
            // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøá‰∫ÜËÆæÂÆöÁöÑ‰ª£Êï∞ÈôêÂà∂
            if (!parentData.children || parentData.children.length === 0 || generation >= currentGenerations) {
                return;
            }
            
            const currentGenMembers = [];
            const nextGenData = [];
            
            // Êî∂ÈõÜÂΩìÂâç‰ª£ÁöÑÊâÄÊúâÊàêÂëò
            for (const child of parentData.children) {
                currentGenMembers.push({
                    individual: child.individual,
                    isSpouse: false,
                    generation: generation,
                    motherId: child.individual.mother_id
                });
                
                // Ëé∑ÂèñÂ≠êÂ•≥ÁöÑÈÖçÂÅ∂
                try {
                    const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${child.individual.individual_id}/spouses?_=${Date.now()}`, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    const spousesData = await spousesResponse.json();
                    
                    if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                        spousesData.data.forEach(spouse => {
                            currentGenMembers.push({
                                individual: spouse,
                                isSpouse: true,
                                generation: generation
                            });
                        });
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÈÖçÂÅ∂‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
                
                // Êî∂ÈõÜ‰∏ã‰∏Ä‰ª£Êï∞ÊçÆÔºàÂè™ÊúâÂú®Êú™ËææÂà∞‰ª£Êï∞ÈôêÂà∂Êó∂ÊâçÊî∂ÈõÜÔºâ
                if (child.children && child.children.length > 0 && generation + 1 < currentGenerations) {
                    nextGenData.push(child);
                }
            }
            
            // Ê∑ªÂä†ÂΩìÂâç‰ª£Âà∞levels
            if (currentGenMembers.length > 0) {
                levels.push({ members: currentGenMembers, generation });
            }
            
            // ÈÄíÂΩíÂ§ÑÁêÜ‰∏ã‰∏Ä‰ª£ÔºàÂè™ÊúâÂú®Êú™ËææÂà∞‰ª£Êï∞ÈôêÂà∂Êó∂ÊâçÈÄíÂΩíÔºâ
            if (nextGenData.length > 0 && generation + 1 < currentGenerations) {
                const combinedNextGen = {
                    children: nextGenData.flatMap(parent => parent.children)
                };
                await collectDescendantsByGeneration(combinedNextGen, levels, generation + 1);
            }
        }

        // Ëé∑ÂèñËäÇÁÇπÁ±ªÂûã
        function getNodeClass(member, level, rootLevel) {
            if (level < rootLevel) return 'ancestor-node';
            if (level === rootLevel) return member.isSpouse ? 'spouse-node' : 'root-node';
            return member.isSpouse ? 'spouse-node' : (level === rootLevel + 1 ? 'child-node' : 'descendant-node');
        }

        // Ëé∑ÂèñËäÇÁÇπÊ†áÁ≠æ
        function getNodeLabel(member, level, rootLevel) {
            if (level < rootLevel) return 'Áà∂ÊØç';
            if (level === rootLevel) {
                if (member.isSpouse) {
                    const wifeOrder = member.individual.marriage_order || 1;
                    if (member.individual.gender === 'female') {
                        return wifeOrder > 1 ? `Á¨¨${wifeOrder}‰ªªÂ¶ªÂ≠ê` : 'Â¶ªÂ≠ê';
                    }
                    return 'ÈÖçÂÅ∂';
                }
                return 'Êú¨‰∫∫';
            }
            if (member.isSpouse) return 'ÈÖçÂÅ∂';
            if (level === rootLevel + 1) return 'Â≠êÂ•≥';
            return `Á¨¨${level - rootLevel + 1}‰ª£`;
        }

        // ÁªòÂà∂ËøûÊé•Á∫ø
        function drawConnections(treeStructure) {
            console.log('=== ÂºÄÂßãÁªòÂà∂ÊâÄÊúâËøûÊé•Á∫ø ===');
            const svg = document.getElementById('treeConnections');
            if (!svg) {
                console.error('Êâæ‰∏çÂà∞SVGÂÖÉÁ¥† #treeConnections');
                return;
            }
            
            console.log('SVGÂÖÉÁ¥†:', svg);
            console.log('SVGÂΩìÂâçÂ≠êÂÖÉÁ¥†Êï∞Èáè:', svg.children.length);
            
            svg.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâËøûÊé•Á∫ø
            
            const treeWrapper = svg.parentElement;
            const rect = treeWrapper.getBoundingClientRect();
            svg.setAttribute('width', rect.width);
            svg.setAttribute('height', rect.height);
            
            console.log('SVGÂ∞∫ÂØ∏ËÆæÁΩÆ:', {width: rect.width, height: rect.height});
            console.log('SVGÊ†∑Âºè:', window.getComputedStyle(svg));
            
            // ÁªòÂà∂Áà∂Â≠êËøûÊé•Á∫ø
            for (let level = 0; level < treeStructure.levels.length - 1; level++) {
                const currentLevel = treeWrapper.querySelector(`[data-level="${level}"]`);
                const nextLevel = treeWrapper.querySelector(`[data-level="${level + 1}"]`);
                
                console.log(`Â§ÑÁêÜÂ±ÇÁ∫ß ${level} -> ${level + 1}`);
                console.log('ÂΩìÂâçÂ±ÇÂÖÉÁ¥†:', currentLevel);
                console.log('‰∏ã‰∏ÄÂ±ÇÂÖÉÁ¥†:', nextLevel);
                
                if (currentLevel && nextLevel) {
                    drawParentChildConnections(svg, currentLevel, nextLevel, treeWrapper, treeStructure);
                } else {
                    console.log(`Ë∑≥ËøáÂ±ÇÁ∫ß ${level} -> ${level + 1}ÔºåÂÖÉÁ¥†‰∏çÂ≠òÂú®`);
                }
            }
            
            // ÁªòÂà∂ÈÖçÂÅ∂ËøûÊé•Á∫ø
            treeStructure.levels.forEach((levelData, level) => {
                const levelElement = treeWrapper.querySelector(`[data-level="${level}"]`);
                if (levelElement) {
                    console.log(`ÁªòÂà∂Â±ÇÁ∫ß ${level} ÁöÑÈÖçÂÅ∂ËøûÊé•Á∫ø`);
                    drawSpouseConnections(svg, levelElement, treeWrapper);
                }
            });
            
            console.log('ËøûÊé•Á∫øÁªòÂà∂ÂÆåÊàêÔºåSVGÂ≠êÂÖÉÁ¥†Êï∞Èáè:', svg.children.length);
            console.log('SVGÊâÄÊúâÂ≠êÂÖÉÁ¥†:', Array.from(svg.children));
        }

        // ÁªòÂà∂Áà∂Â≠êËøûÊé•Á∫ø
        function drawParentChildConnections(svg, parentLevel, childLevel, container, treeStructure) {
            console.log('=== ÂºÄÂßãÁªòÂà∂Áà∂Â≠êËøûÊé•Á∫ø ===');
            const parentNodes = parentLevel.querySelectorAll('.tree-node:not(.spouse-node)');
            const childNodes = childLevel.querySelectorAll('.tree-node:not(.spouse-node)');
            
            console.log('Áà∂ËäÇÁÇπÊï∞Èáè:', parentNodes.length);
            console.log('Â≠êËäÇÁÇπÊï∞Èáè:', childNodes.length);
            console.log('Áà∂ËäÇÁÇπ:', Array.from(parentNodes).map(n => ({id: n.dataset.id, name: n.querySelector('.node-name').textContent})));
            console.log('Â≠êËäÇÁÇπ:', Array.from(childNodes).map(n => ({id: n.dataset.id, name: n.querySelector('.node-name').textContent})));
            
            if (parentNodes.length === 0 || childNodes.length === 0) {
                console.log('Áà∂ËäÇÁÇπÊàñÂ≠êËäÇÁÇπ‰∏∫Á©∫ÔºåË∑≥ËøáËøûÊé•Á∫øÁªòÂà∂');
                return;
            }
            
            const containerRect = container.getBoundingClientRect();
            
            // ÊûÑÂª∫Áà∂Â≠êÂÖ≥Á≥ªÊò†Â∞Ñ
            const parentChildMap = new Map();
            
            // Ëé∑ÂèñÊØè‰∏™Áà∂ËäÇÁÇπÁöÑÂ≠êËäÇÁÇπ
            console.log('=== ÂºÄÂßãÊûÑÂª∫Áà∂Â≠êÂÖ≥Á≥ªÊò†Â∞Ñ ===');
            
            // Áî®‰∫éË∑üË∏™Â∑≤ÁªèÂ§ÑÁêÜËøáÁöÑÂ≠êÂ•≥ÔºåÈÅøÂÖçÂ§´Â¶ªÈáçÂ§çËøûÊé•
            const processedChildren = new Set();
            
            // È¶ñÂÖàÂ§ÑÁêÜÊâÄÊúâÁî∑ÊÄßÁà∂ËäÇÁÇπÔºàÁà∂‰∫≤Ôºâ
            const maleParents = Array.from(parentNodes).filter(node => {
                const parentId = parseInt(node.dataset.id);
                // ‰ªéÊ†ëÁªìÊûÑ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÊàêÂëò‰ø°ÊÅØ
                for (let level = 0; level < treeStructure.levels.length; level++) {
                    const member = treeStructure.levels[level].members.find(m => 
                        m.individual.individual_id === parentId
                    );
                    if (member && member.individual.gender === 'male') {
                        return true;
                    }
                }
                return false;
            });
            
            // ÁÑ∂ÂêéÂ§ÑÁêÜÊâÄÊúâÂ•≥ÊÄßÁà∂ËäÇÁÇπÔºàÊØç‰∫≤Ôºâ
            const femaleParents = Array.from(parentNodes).filter(node => {
                const parentId = parseInt(node.dataset.id);
                // ‰ªéÊ†ëÁªìÊûÑ‰∏≠ÊâæÂà∞ÂØπÂ∫îÁöÑÊàêÂëò‰ø°ÊÅØ
                for (let level = 0; level < treeStructure.levels.length; level++) {
                    const member = treeStructure.levels[level].members.find(m => 
                        m.individual.individual_id === parentId
                    );
                    if (member && member.individual.gender === 'female') {
                        return true;
                    }
                }
                return false;
            });
            
            // ÊåâÈ°∫Â∫èÂ§ÑÁêÜÔºöÂÖàÁà∂‰∫≤ÔºåÂêéÊØç‰∫≤
            const orderedParents = [...maleParents, ...femaleParents];
            
            orderedParents.forEach(parentNode => {
                const parentId = parseInt(parentNode.dataset.id);
                const parentName = parentNode.querySelector('.node-name').textContent;
                const children = [];
                
                console.log(`Ê£ÄÊü•Áà∂ËäÇÁÇπ: ${parentName} (ID: ${parentId})`);
                
                childNodes.forEach(childNode => {
                    const childId = parseInt(childNode.dataset.id);
                    const childName = childNode.querySelector('.node-name').textContent;
                    
                    // Â¶ÇÊûúËøô‰∏™Â≠êÂ•≥Â∑≤ÁªèË¢´Â§ÑÁêÜËøáÔºàÈÄöÂ∏∏ÊòØË¢´Áà∂‰∫≤Â§ÑÁêÜÔºâÔºåË∑≥Ëøá
                    if (processedChildren.has(childId)) {
                        console.log(`  Ë∑≥ËøáÂ≠êËäÇÁÇπ: ${childName} (Â∑≤Ë¢´ÂÖ∂‰ªñÁà∂ÊØçËøûÊé•)`);
                        return;
                    }
                    
                    console.log(`  Ê£ÄÊü•Â≠êËäÇÁÇπ: ${childName} (ID: ${childId})`);
                    
                    if (isParentChild(parentId, childId, treeStructure)) {
                        console.log(`  ‚úì ÊâæÂà∞Áà∂Â≠êÂÖ≥Á≥ª: ${parentName} -> ${childName}`);
                        children.push(childNode);
                        // Ê†áËÆ∞Ëøô‰∏™Â≠êÂ•≥Â∑≤Ë¢´Â§ÑÁêÜÔºåÈÅøÂÖçÂÖ∂‰ªñÁà∂ÊØçÈáçÂ§çËøûÊé•
                        processedChildren.add(childId);
                    } else {
                        console.log(`  ‚úó Êó†Áà∂Â≠êÂÖ≥Á≥ª: ${parentName} -> ${childName}`);
                    }
                });
                
                if (children.length > 0) {
                    console.log(`Áà∂ËäÇÁÇπ ${parentName} Êúâ ${children.length} ‰∏™Â≠êËäÇÁÇπ`);
                    parentChildMap.set(parentNode, children);
                } else {
                    console.log(`Áà∂ËäÇÁÇπ ${parentName} Ê≤°ÊúâÂ≠êËäÇÁÇπ`);
                }
            });
            
            console.log('Áà∂Â≠êÂÖ≥Á≥ªÊò†Â∞ÑÂ§ßÂ∞è:', parentChildMap.size);
            
            // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™Áà∂ËäÇÁÇπÔºå‰ΩøÁî®ÁÆÄÂçïËøûÊé•
            if (parentChildMap.size === 1) {
                console.log('‰ΩøÁî®ÁÆÄÂçïËøûÊé•ÔºàÂçï‰∏™Áà∂ËäÇÁÇπÔºâ');
                const [parentNode, children] = parentChildMap.entries().next().value;
                drawSimpleParentChildConnection(svg, parentNode, children, containerRect);
            } else if (parentChildMap.size > 1) {
                console.log('‰ΩøÁî®Â§öÁà∂ËäÇÁÇπËøûÊé•');
                // Â§ö‰∏™Áà∂ËäÇÁÇπÊó∂Ôºå‰ΩøÁî®ÂàÜÂ±ÇËøûÊé•ÈÅøÂÖçÁõ∏‰∫§
                drawMultiParentChildConnections(svg, parentChildMap, containerRect);
            } else {
                console.log('Ê≤°ÊúâÊâæÂà∞‰ªª‰ΩïÁà∂Â≠êÂÖ≥Á≥ªÔºåË∑≥ËøáËøûÊé•Á∫øÁªòÂà∂');
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶‰∏∫Áà∂Â≠êÂÖ≥Á≥ªÔºàÂü∫‰∫éÊ†ëÁªìÊûÑÊï∞ÊçÆÔºâ
        function isParentChild(parentId, childId, treeStructure) {
            // ÊµãËØïÂáΩÊï∞ÊòØÂê¶Ë¢´Ë∞ÉÁî® - Ê£ÄÊü•‰ªª‰ΩïÁà∂Â≠êÂÖ≥Á≥ª
            console.log('=== Ê£ÄÊü•Áà∂Â≠êÂÖ≥Á≥ª (‰øÆÂ§çÁâà) ===');
            console.log('Áà∂ID:', parentId, 'Â≠êID:', childId);
            
            // ÈÅçÂéÜÊ†ëÁªìÊûÑÔºåÊü•ÊâæÁà∂Â≠êÂÖ≥Á≥ª
            for (let level = 0; level < treeStructure.levels.length - 1; level++) {
                const currentLevelMembers = treeStructure.levels[level].members;
                const nextLevelMembers = treeStructure.levels[level + 1].members;
                
                console.log(`Ê£ÄÊü•Â±ÇÁ∫ß ${level} -> ${level + 1}`);
                console.log('ÂΩìÂâçÂ±ÇÊàêÂëò:', currentLevelMembers.map(m => ({id: m.individual.individual_id, name: m.individual.full_name, isSpouse: m.isSpouse})));
                console.log('‰∏ã‰∏ÄÂ±ÇÊàêÂëò:', nextLevelMembers.map(m => ({id: m.individual.individual_id, name: m.individual.full_name, isSpouse: m.isSpouse})));
                
                // Ê£ÄÊü•Áà∂ËäÇÁÇπÊòØÂê¶Âú®ÂΩìÂâçÂ±ÇÔºàÂåÖÊã¨ÈÖçÂÅ∂ÔºåÂõ†‰∏∫ÈÖçÂÅ∂‰πüÂèØËÉΩÊòØÁà∂ÊØçÔºâ
                const parentMember = currentLevelMembers.find(m => 
                    m.individual.individual_id === parentId
                );
                
                if (parentMember) {
                    console.log('ÊâæÂà∞Áà∂ËäÇÁÇπ:', parentMember.individual.full_name);
                    
                    // Ê£ÄÊü•Â≠êËäÇÁÇπÊòØÂê¶Âú®‰∏ã‰∏ÄÂ±Ç
                    const childMember = nextLevelMembers.find(m => 
                        !m.isSpouse && m.individual.individual_id === childId
                    );
                    
                    if (childMember) {
                        console.log('ÊâæÂà∞Â≠êËäÇÁÇπ:', childMember.individual.full_name);
                        console.log('Â≠êËäÇÁÇπÁöÑÁà∂‰∫≤ID:', childMember.individual.father_id);
                        console.log('Â≠êËäÇÁÇπÁöÑÊØç‰∫≤ID:', childMember.individual.mother_id);
                        
                        // Ê£ÄÊü•ÂÆûÈôÖÁöÑÁà∂Â≠êÂÖ≥Á≥ª
                        const isParent = (childMember.individual.father_id === parentId || 
                                         childMember.individual.mother_id === parentId);
                        console.log('ÊòØÂê¶‰∏∫Áà∂Â≠êÂÖ≥Á≥ª:', isParent);
                        
                        if (isParent) {
                            return true;
                        }
                    }
                }
            }
            console.log('Êú™ÊâæÂà∞Áà∂Â≠êÂÖ≥Á≥ª');
            return false;
        }
        
        // ÁªòÂà∂ÁÆÄÂçïÁöÑÁà∂Â≠êËøûÊé•ÔºàÂçï‰∏™Áà∂ËäÇÁÇπÔºâ
        function drawSimpleParentChildConnection(svg, parentNode, children, containerRect) {
            console.log('=== ÁªòÂà∂ÁÆÄÂçïÁà∂Â≠êËøûÊé• ===');
            console.log('Áà∂ËäÇÁÇπ:', parentNode.querySelector('.node-name').textContent);
            console.log('Â≠êËäÇÁÇπÊï∞Èáè:', children.length);
            console.log('Â≠êËäÇÁÇπ:', children.map(c => c.querySelector('.node-name').textContent));
            
            const parentRect = parentNode.getBoundingClientRect();
            const parentX = parentRect.left + parentRect.width / 2 - containerRect.left;
            const parentY = parentRect.bottom - containerRect.top;
            
            console.log('Áà∂ËäÇÁÇπÂùêÊ†á:', {x: parentX, y: parentY});
            
            if (children.length === 1) {
                console.log('ÁªòÂà∂Âçï‰∏™Â≠êËäÇÁÇπËøûÊé•');
                // Âçï‰∏™Â≠êËäÇÁÇπÔºåÁõ¥Êé•ËøûÊé•
                const childRect = children[0].getBoundingClientRect();
                const childX = childRect.left + childRect.width / 2 - containerRect.left;
                const childY = childRect.top - containerRect.top;
                
                console.log('Â≠êËäÇÁÇπÂùêÊ†á:', {x: childX, y: childY});
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const midY = parentY + (childY - parentY) / 2;
                const path = `M ${parentX} ${parentY} L ${parentX} ${midY} L ${childX} ${midY} L ${childX} ${childY}`;
                
                console.log('ËøûÊé•Á∫øË∑ØÂæÑ:', path);
                
                line.setAttribute('d', path);
                line.setAttribute('class', 'connection-line parent-child');
                svg.appendChild(line);
                
                console.log('ËøûÊé•Á∫øÂ∑≤Ê∑ªÂä†Âà∞SVG');
            } else {
                console.log('ÁªòÂà∂Â§ö‰∏™Â≠êËäÇÁÇπTÂûãËøûÊé•');
                // Â§ö‰∏™Â≠êËäÇÁÇπÔºå‰ΩøÁî®TÂûãËøûÊé•
                const childPositions = children.map(child => {
                    const rect = child.getBoundingClientRect();
                    return {
                        x: rect.left + rect.width / 2 - containerRect.left,
                        y: rect.top - containerRect.top
                    };
                });
                
                console.log('Â≠êËäÇÁÇπ‰ΩçÁΩÆ:', childPositions);
                
                // ÊâæÂà∞Â≠êËäÇÁÇπÁöÑXÂùêÊ†áËåÉÂõ¥
                const minChildX = Math.min(...childPositions.map(pos => pos.x));
                const maxChildX = Math.max(...childPositions.map(pos => pos.x));
                const childY = childPositions[0].y; // ÂÅáËÆæÊâÄÊúâÂ≠êËäÇÁÇπÂú®Âêå‰∏ÄÊ∞¥Âπ≥Á∫ø
                
                const midY = parentY + (childY - parentY) / 2;
                
                console.log('TÂûãËøûÊé•ÂèÇÊï∞:', {minChildX, maxChildX, childY, midY});
                
                // ÁªòÂà∂‰ªéÁà∂ËäÇÁÇπÂà∞Ê∞¥Âπ≥Á∫øÁöÑÂûÇÁõ¥Á∫ø
                const verticalLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                verticalLine.setAttribute('x1', parentX);
                verticalLine.setAttribute('y1', parentY);
                verticalLine.setAttribute('x2', parentX);
                verticalLine.setAttribute('y2', midY);
                verticalLine.setAttribute('class', 'connection-line parent-child');
                svg.appendChild(verticalLine);
                
                // ÁªòÂà∂Ê∞¥Âπ≥ËøûÊé•Á∫ø - ‰øÆÂ§çÔºöÂ∫îËØ•‰ªéÁà∂ËäÇÁÇπXÂùêÊ†áÂºÄÂßãÔºåÂà∞ÊúÄËøúÂ≠êËäÇÁÇπÁªìÊùü
                const horizontalLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                const horizontalStartX = Math.min(parentX, minChildX);
                const horizontalEndX = Math.max(parentX, maxChildX);
                horizontalLine.setAttribute('x1', horizontalStartX);
                horizontalLine.setAttribute('y1', midY);
                horizontalLine.setAttribute('x2', horizontalEndX);
                horizontalLine.setAttribute('y2', midY);
                horizontalLine.setAttribute('class', 'connection-line parent-child');
                svg.appendChild(horizontalLine);
                
                console.log('‰øÆÂ§çÂêéÁöÑÊ∞¥Âπ≥Á∫øÂùêÊ†á:', {x1: horizontalStartX, x2: horizontalEndX, y: midY});
                
                // ÁªòÂà∂‰ªéÊ∞¥Âπ≥Á∫øÂà∞ÊØè‰∏™Â≠êËäÇÁÇπÁöÑÂûÇÁõ¥Á∫ø
                childPositions.forEach(pos => {
                    const childVerticalLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    childVerticalLine.setAttribute('x1', pos.x);
                    childVerticalLine.setAttribute('y1', midY);
                    childVerticalLine.setAttribute('x2', pos.x);
                    childVerticalLine.setAttribute('y2', pos.y);
                    childVerticalLine.setAttribute('class', 'connection-line parent-child');
                    svg.appendChild(childVerticalLine);
                });
                
                console.log('TÂûãËøûÊé•Á∫øÂ∑≤Ê∑ªÂä†Âà∞SVG');
            }
        }
        
        // ÁªòÂà∂Â§öÁà∂ËäÇÁÇπÁöÑÂ≠êËøûÊé•ÔºàÈÅøÂÖçÁõ∏‰∫§Ôºâ
        function drawMultiParentChildConnections(svg, parentChildMap, containerRect) {
            const parentEntries = Array.from(parentChildMap.entries());
            const baseOffset = 20; // Âü∫Á°ÄÂÅèÁßªÈáè
            
            parentEntries.forEach(([parentNode, children], index) => {
                const parentRect = parentNode.getBoundingClientRect();
                const parentX = parentRect.left + parentRect.width / 2 - containerRect.left;
                const parentY = parentRect.bottom - containerRect.top;
                
                // ‰∏∫ÊØè‰∏™Áà∂ËäÇÁÇπ‰ΩøÁî®‰∏çÂêåÁöÑ‰∏≠Èó¥YÂùêÊ†áÔºåÈÅøÂÖçÁõ∏‰∫§
                const offsetY = baseOffset + (index * 15);
                
                children.forEach(child => {
                    const childRect = child.getBoundingClientRect();
                    const childX = childRect.left + childRect.width / 2 - containerRect.left;
                    const childY = childRect.top - containerRect.top;
                    
                    const midY = parentY + offsetY;
                    
                    // ÁªòÂà∂LÂûãËøûÊé•Á∫ø
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = `M ${parentX} ${parentY} L ${parentX} ${midY} L ${childX} ${midY} L ${childX} ${childY}`;
                    
                    path.setAttribute('d', pathData);
                    path.setAttribute('class', 'connection-line parent-child');
                    path.setAttribute('stroke-dasharray', 'none'); // Áªü‰∏Ä‰ΩøÁî®ÂÆûÁ∫øÔºå‰∏çÂÜçÂå∫ÂàÜÁ¨¨‰∏Ä‰∏™ÂíåÂÖ∂‰ªñÁà∂ËäÇÁÇπ
                    svg.appendChild(path);
                });
            });
        }

        // ÁªòÂà∂ÈÖçÂÅ∂ËøûÊé•Á∫ø
        function drawSpouseConnections(svg, levelElement, container) {
            console.log('=== ÁªòÂà∂ÈÖçÂÅ∂ËøûÊé•Á∫ø ===');
            const nodes = levelElement.querySelectorAll('.tree-node');
            const containerRect = container.getBoundingClientRect();
            
            console.log('Â±ÇÁ∫ßÂÖÉÁ¥†:', levelElement);
            console.log('ËäÇÁÇπÊï∞Èáè:', nodes.length);
            console.log('ËäÇÁÇπÂàóË°®:', Array.from(nodes).map(n => ({
                name: n.querySelector('.node-name')?.textContent,
                id: n.dataset.id,
                class: n.className
            })));
            
            for (let i = 0; i < nodes.length - 1; i++) {
                const node1 = nodes[i];
                const node2 = nodes[i + 1];
                
                console.log(`Ê£ÄÊü•ËäÇÁÇπÂØπ ${i} -> ${i+1}:`);
                console.log('ËäÇÁÇπ1:', node1.querySelector('.node-name')?.textContent);
                console.log('ËäÇÁÇπ2:', node2.querySelector('.node-name')?.textContent);
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÈÖçÂÅ∂ÂÖ≥Á≥ªÔºàÈÄöËøámarriage-connectorÂà§Êñ≠Ôºâ
                const connector = node1.nextElementSibling;
                console.log('ËøûÊé•Âô®ÂÖÉÁ¥†:', connector);
                console.log('ËøûÊé•Âô®Á±ªÂêç:', connector?.className);
                
                if (connector && connector.classList.contains('marriage-connector')) {
                    console.log('‚úì ÊâæÂà∞ÈÖçÂÅ∂ËøûÊé•Âô®ÔºåÁªòÂà∂ËøûÊé•Á∫ø');
                    const rect1 = node1.getBoundingClientRect();
                    const rect2 = node2.getBoundingClientRect();
                    
                    const x1 = rect1.right - containerRect.left;
                    const y1 = rect1.top + rect1.height / 2 - containerRect.top;
                    const x2 = rect2.left - containerRect.left;
                    const y2 = rect2.top + rect2.height / 2 - containerRect.top;
                    
                    console.log('ÈÖçÂÅ∂ËøûÊé•Á∫øÂùêÊ†á:', {x1, y1, x2, y2});
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('class', 'connection-line spouse');
                    svg.appendChild(line);
                    
                    console.log('ÈÖçÂÅ∂ËøûÊé•Á∫øÂ∑≤Ê∑ªÂä†Âà∞SVG');
                } else {
                    console.log('‚úó Êú™ÊâæÂà∞ÈÖçÂÅ∂ËøûÊé•Âô®');
                }
            }
        }

        // Ëé∑ÂèñËäÇÁÇπÁ±ªÂûã
        function getNodeClass(member, level, rootLevel) {
            if (level < rootLevel) return 'ancestor-node';
            if (level === rootLevel) return member.isSpouse ? 'spouse-node' : 'root-node';
            return member.isSpouse ? 'spouse-node' : (level === rootLevel + 1 ? 'child-node' : 'descendant-node');
        }

        // Ëé∑ÂèñËäÇÁÇπÊ†áÁ≠æ
        function getNodeLabel(member, level, rootLevel) {
            if (level < rootLevel) return 'Áà∂ÊØç';
            if (level === rootLevel) {
                if (member.isSpouse) {
                    const wifeOrder = member.individual.marriage_order || 1;
                    if (member.individual.gender === 'female') {
                        return wifeOrder > 1 ? `Á¨¨${wifeOrder}‰ªªÂ¶ªÂ≠ê` : 'Â¶ªÂ≠ê';
                    }
                    return 'ÈÖçÂÅ∂';
                }
                return 'Êú¨‰∫∫';
            }
            if (member.isSpouse) return 'ÈÖçÂÅ∂';
            if (level === rootLevel + 1) return 'Â≠êÂ•≥';
            return `Á¨¨${level - rootLevel + 1}‰ª£`;
        }

        

        // Ê∏≤ÊüìÊ†ëËäÇÁÇπ
        function renderTreeNode(individual, nodeClass, label, compact = false) {
            const compactClass = compact ? ' compact' : '';
            const birthYear = individual.birth_date ? new Date(individual.birth_date).getFullYear() : '';
            const deathYear = individual.death_date ? new Date(individual.death_date).getFullYear() : '';
            const lifeSpan = birthYear ? (deathYear ? `${birthYear}-${deathYear}` : `${birthYear}-`) : '';
            
            return `
                <div class="tree-node ${nodeClass}${compactClass}" data-id="${individual.individual_id}">
                    <div class="node-name">${individual.full_name}</div>
                    ${!compact ? `
                        <div class="node-details">${individual.gender === 'male' ? '‚ôÇ' : '‚ôÄ'} ${label}</div>
                        ${lifeSpan ? `<div class="node-details">${lifeSpan}</div>` : ''}
                        ${individual.occupation ? `<div class="node-occupation">${individual.occupation}</div>` : ''}
                    ` : ''}
                </div>
            `;
        }



        // ÈÄâÊã©ËäÇÁÇπ
        function selectNode(nodeId) {
            console.log('selectNode Ë¢´Ë∞ÉÁî®ÔºånodeId:', nodeId);
            selectedNodeId = nodeId;
            // ÊòæÁ§∫ÊàêÂëòËØ¶ÁªÜ‰ø°ÊÅØ
            showMemberDetails(nodeId);
        }

        // ÊòæÁ§∫ÊàêÂëòËØ¶ÁªÜ‰ø°ÊÅØ
        async function showMemberDetails(memberId) {
            try {
                // È¶ñÂÖàÂ∞ùËØï‰ªéallMembers‰∏≠Êü•Êâæ
                let member = allMembers.find(m => m.individual_id === memberId);
                
                // Â¶ÇÊûúÂú®allMembers‰∏≠Êâæ‰∏çÂà∞Ôºå‰ªéAPIËé∑Âèñ
                if (!member) {
                    const response = await authenticatedFetch(`/api/v1/individuals/${memberId}?_=${Date.now()}`, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        member = data.data;
                    } else {
                        showNotification('Êó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                        return;
                    }
                }
                
                // ÊûÑÂª∫ËØ¶ÁªÜ‰ø°ÊÅØHTML
                const detailsHtml = `
                    <div class="member-details">
                        <div class="detail-section">
                            <h3>üë§ Âü∫Êú¨‰ø°ÊÅØ</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>ÂßìÂêçÔºö</label>
                                    <span>${member.full_name}</span>
                                </div>
                                <div class="detail-item">
                                    <label>ÊÄßÂà´Ôºö</label>
                                    <span>${member.gender === 'male' ? '‚ôÇ Áî∑' : '‚ôÄ Â•≥'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Âá∫ÁîüÊó•ÊúüÔºö</label>
                                    <span>${member.birth_date ? formatDate(member.birth_date) : 'Êú™Áü•'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Ê≠ª‰∫°Êó•ÊúüÔºö</label>
                                    <span>${member.death_date ? formatDate(member.death_date) : 'Âú®‰∏ñ'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>ËÅå‰∏öÔºö</label>
                                    <span>${member.occupation || 'Êú™Áü•'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>Âá∫ÁîüÂú∞Ôºö</label>
                                    <span>${member.birth_place || 'Êú™Áü•'}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${member.notes ? `
                        <div class="detail-section">
                            <h3>üìù Â§áÊ≥®‰ø°ÊÅØ</h3>
                            <div class="notes-content">${member.notes}</div>
                        </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <h3>üå≥ ÂÆ∂ÊóèÂÖ≥Á≥ª</h3>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <label>Áà∂‰∫≤IDÔºö</label>
                                    <span>${member.father_id || 'Êú™Áü•'}</span>
                                </div>
                                <div class="detail-item">
                                    <label>ÊØç‰∫≤IDÔºö</label>
                                    <span>${member.mother_id || 'Êú™Áü•'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-actions">
                            <button class="btn btn-primary" onclick="showFamilyTreeAndCloseModal(${member.individual_id})">
                                <i class="fas fa-sitemap"></i> Êü•ÁúãÂÆ∂ÊóèÊ†ë
                            </button>
                            <button class="btn btn-secondary" onclick="closeDetailsModal()">
                                <i class="fas fa-times"></i> ÂÖ≥Èó≠
                            </button>
                        </div>
                    </div>
                `;
                
                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                document.getElementById('detailsContent').innerHTML = detailsHtml;
                document.getElementById('detailsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊàêÂëòËØ¶ÁªÜ‰ø°ÊÅØÂ§±Ë¥•:', error);
                showNotification('Ëé∑ÂèñÊàêÂëò‰ø°ÊÅØÂ§±Ë¥•', 'error');
            }
        }

        // ÊòæÁ§∫Âè≥ÈîÆËèúÂçï
        function showContextMenu(event, nodeElement) {
            console.log('=== showContextMenu Ë¢´Ë∞ÉÁî® ===');
            console.log('ÂèÇÊï∞:', nodeElement);
            console.log('‰∫ã‰ª∂:', event);
            
            // Â¶ÇÊûú‰º†ÂÖ•ÁöÑÊòØÊï∞Â≠óIDÔºåÂàôÊü•ÊâæÂØπÂ∫îÁöÑDOMÂÖÉÁ¥†
            if (typeof nodeElement === 'number') {
                const nodeId = nodeElement;
                contextMenuNode = nodeId;
                selectedNodeId = nodeId;
                console.log('ËÆæÁΩÆ contextMenuNode ‰∏∫:', nodeId);
            } else if (nodeElement && nodeElement.dataset) {
                // Â¶ÇÊûú‰º†ÂÖ•ÁöÑÊòØDOMÂÖÉÁ¥†
                const nodeId = parseInt(nodeElement.dataset.id);
                contextMenuNode = nodeId;
                selectedNodeId = nodeId;
                console.log('‰ªéDOMÂÖÉÁ¥†Ëé∑Âèñ contextMenuNode:', nodeId);
            } else {
                console.error('showContextMenu: Êó†ÊïàÁöÑËäÇÁÇπÂèÇÊï∞', nodeElement);
                return;
            }
            
            const menu = document.getElementById('contextMenu');
            if (!menu) {
                console.error('Êâæ‰∏çÂà∞ contextMenu ÂÖÉÁ¥†');
                return;
            }
            
            console.log('contextMenuNode ÊúÄÁªàËÆæÁΩÆ‰∏∫:', contextMenuNode);
            
            // ÂÖàÊòæÁ§∫ËèúÂçï‰ª•Ëé∑ÂèñÂÖ∂Â∞∫ÂØ∏Ôºå‰ΩÜÊîæÂú®Â±èÂπïÂ§ñ
            menu.style.display = 'block';
            menu.style.left = '-9999px';
            menu.style.top = '-9999px';
            menu.style.visibility = 'visible';
            
            // Âº∫Âà∂ÈáçÊñ∞ËÆ°ÁÆóÂ∏ÉÂ±Ä
            menu.offsetHeight;
            
            // Ëé∑ÂèñËèúÂçïÂ∞∫ÂØ∏ÂíåÁ™óÂè£Â∞∫ÂØ∏
            const menuRect = menu.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            console.log('ËèúÂçïÂ∞∫ÂØ∏:', menuRect.width, 'x', menuRect.height);
            console.log('Á™óÂè£Â∞∫ÂØ∏:', windowWidth, 'x', windowHeight);
            console.log('Èº†Ê†á‰ΩçÁΩÆ:', event.clientX, event.clientY);
            console.log('È°µÈù¢ÊªöÂä®:', scrollX, scrollY);
            
            // ËÆ°ÁÆóÊúÄ‰Ω≥‰ΩçÁΩÆÔºà‰ΩøÁî®clientX/YÔºåÂõ†‰∏∫ËèúÂçïÊòØfixedÂÆö‰ΩçÔºâ
            let left = event.clientX;
            let top = event.clientY;
            
            const margin = 15; // ËæπË∑ù
            
            // Ê£ÄÊü•Âè≥ËæπÁïå - Â¶ÇÊûúËèúÂçï‰ºöË∂ÖÂá∫Âè≥ËæπÔºåÂàôÂêëÂ∑¶Ë∞ÉÊï¥
            if (left + menuRect.width + margin > windowWidth) {
                left = Math.max(margin, windowWidth - menuRect.width - margin);
                console.log('Ë∞ÉÊï¥Âè≥ËæπÁïåÔºåÊñ∞left:', left);
            }
            
            // Ê£ÄÊü•‰∏ãËæπÁïå - Â¶ÇÊûúËèúÂçï‰ºöË∂ÖÂá∫‰∏ãËæπÔºåÂàôÂêë‰∏äË∞ÉÊï¥
            if (top + menuRect.height + margin > windowHeight) {
                top = Math.max(margin, windowHeight - menuRect.height - margin);
                console.log('Ë∞ÉÊï¥‰∏ãËæπÁïåÔºåÊñ∞top:', top);
            }
            
            // Ê£ÄÊü•Â∑¶ËæπÁïå
            if (left < margin) {
                left = margin;
                console.log('Ë∞ÉÊï¥Â∑¶ËæπÁïåÔºåÊñ∞left:', left);
            }
            
            // Ê£ÄÊü•‰∏äËæπÁïå
            if (top < margin) {
                top = margin;
                console.log('Ë∞ÉÊï¥‰∏äËæπÁïåÔºåÊñ∞top:', top);
            }
            
            // ËÆæÁΩÆÊúÄÁªà‰ΩçÁΩÆ
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            
            console.log('Âè≥ÈîÆËèúÂçïÊúÄÁªà‰ΩçÁΩÆ:', left, top, 'ËèúÂçïÂ∞∫ÂØ∏:', menuRect.width, menuRect.height);
        }

        // ÊòæÁ§∫ÂÆ∂ÊóèÊ†ëÂπ∂ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function showFamilyTreeAndCloseModal(memberId) {
            console.log('ÊòæÁ§∫ÂÆ∂ÊóèÊ†ëÂπ∂ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜÔºåÊàêÂëòID:', memberId);
            
            // ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
            closeDetailsModal();
            
            // ÊòæÁ§∫ÂÆ∂ÊóèÊ†ë
            showFamilyTree(memberId);
        }

        // Êõ¥ÊîπÊòæÁ§∫‰ª£Êï∞
        function changeGenerations() {
            currentGenerations = parseInt(document.getElementById('generationSelect').value);
            if (currentRootId) {
                showFamilyTree(currentRootId);
            }
        }

        // Êõ¥Êñ∞Ê†ëÂ§¥ÈÉ®‰ø°ÊÅØ
        function updateTreeHeader(individual) {
            document.getElementById('currentRootName').textContent = individual.full_name + ' ÁöÑÂÆ∂ÊóèÊ†ë';
            document.getElementById('currentGenInfo').textContent = `ÊòæÁ§∫${currentGenerations}‰ª£ÂÖ≥Á≥ª`;
        }

        // ÊòæÁ§∫Ê∑ªÂä†Ê®°ÊÄÅÊ°Ü
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†ÊóèÈïø';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = '';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').style.display = 'block';
        }

        // ÊòæÁ§∫Ê∑ªÂä†Â≠êÂ•≥Ê®°ÊÄÅÊ°Ü
        async function showAddChildModal() {
            console.log('=== showAddChildModal v2.0 Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('allMembers Ââç5‰∏™ÊàêÂëò:', allMembers.slice(0, 5).map(m => ({id: m.individual_id, name: m.full_name})));
            
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫');
                return;
            }
            
            // ÂÖàÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÔºåÈÅøÂÖçÂºÇÊ≠•Êìç‰ΩúÈòªÂ°û
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Â≠êÂ•≥';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'child';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
            
            console.log('Ê®°ÊÄÅÊ°ÜÂ∑≤ÊòæÁ§∫');
            
            // Ëé∑ÂèñÁà∂ÊØç‰ø°ÊÅØ
            let parentMember = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!parentMember) {
                console.error('Êâæ‰∏çÂà∞Áà∂ÊØçÊàêÂëò‰ø°ÊÅØÔºåcontextMenuNode:', contextMenuNode);
                console.error('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await authenticatedFetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        parentMember = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞Áà∂ÊØçÊàêÂëò‰ø°ÊÅØ:', parentMember);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(parentMember);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            handleParentMemberLogic(parentMember);
        }
        
        // Â§ÑÁêÜÁà∂ÊØçÊàêÂëòÈÄªËæëÁöÑÁã¨Á´ãÂáΩÊï∞
        async function handleParentMemberLogic(parentMember) {
            console.log('Áà∂ÊØçÊàêÂëò‰ø°ÊÅØ:', parentMember);
            
            // Â¶ÇÊûúÊòØÁî∑ÊÄßÔºåÊ£ÄÊü•ÊòØÂê¶ÊúâÂ§ö‰∏™Â¶ªÂ≠ê
            if (parentMember.gender === 'male') {
                try {
                    console.log('Ê≠£Âú®Ëé∑ÂèñÈÖçÂÅ∂‰ø°ÊÅØ...');
                    const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}/spouses?_=${Date.now()}`, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    const spousesData = await spousesResponse.json();
                    
                    console.log('ÈÖçÂÅ∂Êï∞ÊçÆ:', spousesData);
                    
                    if (spousesData.success && spousesData.data) {
                        const wives = spousesData.data.filter(spouse => spouse && spouse.gender === 'female');
                        
                        console.log('Â¶ªÂ≠êÂàóË°®:', wives);
                        
                        // ÊòæÁ§∫ÊàñÈöêËóèÊØç‰∫≤ÈÄâÊã©ÁªÑ
                        const wifeSelectionGroup = document.getElementById('wifeSelectionGroup');
                        const selectedWife = document.getElementById('selectedWife');
                        
                        if (wifeSelectionGroup && selectedWife) {
                            if (wives.length > 1) {
                                // Ê∏ÖÁ©∫Âπ∂ÈáçÊñ∞Â°´ÂÖÖÈÄâÈ°π
                                selectedWife.innerHTML = '<option value="">ËØ∑ÈÄâÊã©ÊØç‰∫≤</option>';
                                wives.forEach(wife => {
                                    const option = document.createElement('option');
                                    option.value = wife.individual_id;
                                    const wifeOrder = wife.marriage_order || 1;
                                    option.textContent = `${wife.full_name} (Á¨¨${wifeOrder}‰ªªÂ¶ªÂ≠ê)`;
                                    selectedWife.appendChild(option);
                                });
                                wifeSelectionGroup.style.display = 'block';
                                console.log('ÊòæÁ§∫ÊØç‰∫≤ÈÄâÊã©ÁªÑÔºåÂ§ö‰∏™Â¶ªÂ≠ê');
                            } else if (wives.length === 1) {
                                // Âè™Êúâ‰∏Ä‰∏™Â¶ªÂ≠êÔºåËá™Âä®ÈÄâÊã©
                                selectedWife.value = wives[0].individual_id;
                                wifeSelectionGroup.style.display = 'none';
                                console.log('Ëá™Âä®ÈÄâÊã©ÂîØ‰∏ÄÂ¶ªÂ≠ê:', wives[0].full_name);
                            } else {
                                wifeSelectionGroup.style.display = 'none';
                                console.log('Ê≤°ÊúâÂ¶ªÂ≠êÔºåÈöêËóèÈÄâÊã©ÁªÑ');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÈÖçÂÅ∂‰ø°ÊÅØÂ§±Ë¥•:', error);
                    // Âç≥‰ΩøËé∑ÂèñÈÖçÂÅ∂‰ø°ÊÅØÂ§±Ë¥•Ôºå‰πüË¶ÅÈöêËóèÊØç‰∫≤ÈÄâÊã©ÁªÑ
                    const wifeSelectionGroup = document.getElementById('wifeSelectionGroup');
                    if (wifeSelectionGroup) {
                        wifeSelectionGroup.style.display = 'none';
                    }
                }
            } else {
                // Â¶ÇÊûúÊòØÂ•≥ÊÄßÔºåÈöêËóèÊØç‰∫≤ÈÄâÊã©ÁªÑ
                const wifeSelectionGroup = document.getElementById('wifeSelectionGroup');
                if (wifeSelectionGroup) {
                    wifeSelectionGroup.style.display = 'none';
                }
                console.log('Áà∂ÊØçÊòØÂ•≥ÊÄßÔºåÈöêËóèÊØç‰∫≤ÈÄâÊã©ÁªÑ');
            }
        }

        // ÊòæÁ§∫Ê∑ªÂä†ÈÖçÂÅ∂Ê®°ÊÄÅÊ°Ü
        function showAddSpouseModal() {
            console.log('=== showAddSpouseModal Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊ∑ªÂä†ÈÖçÂÅ∂');
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†ÈÖçÂÅ∂';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'spouse';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ÊòæÁ§∫Ê∑ªÂä†Áà∂‰∫≤Ê®°ÊÄÅÊ°Ü
        async function showAddFatherModal() {
            console.log('=== showAddFatherModal Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊ∑ªÂä†Áà∂‰∫≤');
                return;
            }
            
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('Êü•ÊâæÊàêÂëò ID:', contextMenuNode);
            let member = allMembers.find(m => m.individual_id === contextMenuNode);
            console.log('ÊâæÂà∞ÁöÑÊàêÂëò:', member);
            
            if (!member) {
                console.error('Âú® allMembers ‰∏≠Êâæ‰∏çÂà∞ ID ‰∏∫', contextMenuNode, 'ÁöÑÊàêÂëò');
                console.log('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        member = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞ÊàêÂëò‰ø°ÊÅØ:', member);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(member);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁà∂‰∫≤
            if (member.father_id) {
                showNotification('ËØ•ÊàêÂëòÂ∑≤ÊúâÁà∂‰∫≤‰ø°ÊÅØ', 'warning');
                document.getElementById('contextMenu').style.display = 'none';
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Áà∂‰∫≤';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'father';
            document.getElementById('memberForm').reset();
            // ÈªòËÆ§ËÆæÁΩÆ‰∏∫Áî∑ÊÄß
            document.getElementById('gender').value = 'male';
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ÊòæÁ§∫Ê∑ªÂä†ÊØç‰∫≤Ê®°ÊÄÅÊ°Ü
        async function showAddMotherModal() {
            console.log('=== showAddMotherModal Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊ∑ªÂä†ÊØç‰∫≤');
                return;
            }
            
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('Êü•ÊâæÊàêÂëò ID:', contextMenuNode);
            let member = allMembers.find(m => m.individual_id === contextMenuNode);
            console.log('ÊâæÂà∞ÁöÑÊàêÂëò:', member);
            
            if (!member) {
                console.error('Âú® allMembers ‰∏≠Êâæ‰∏çÂà∞ ID ‰∏∫', contextMenuNode, 'ÁöÑÊàêÂëò');
                console.log('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        member = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞ÊàêÂëò‰ø°ÊÅØ:', member);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(member);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÊØç‰∫≤
            if (member.mother_id) {
                showNotification('ËØ•ÊàêÂëòÂ∑≤ÊúâÊØç‰∫≤‰ø°ÊÅØ', 'warning');
                document.getElementById('contextMenu').style.display = 'none';
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†ÊØç‰∫≤';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'mother';
            document.getElementById('memberForm').reset();
            // ÈªòËÆ§ËÆæÁΩÆ‰∏∫Â•≥ÊÄß
            document.getElementById('gender').value = 'female';
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ÊòæÁ§∫Êü•ÁúãËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        async function showViewDetailsModal() {
            console.log('=== showViewDetailsModal Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÊü•ÁúãËØ¶ÊÉÖ');
                return;
            }
            
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('Êü•ÊâæÊàêÂëò ID:', contextMenuNode);
            let member = allMembers.find(m => m.individual_id === contextMenuNode);
            console.log('ÊâæÂà∞ÁöÑÊàêÂëò:', member);
            
            if (!member) {
                console.error('Âú® allMembers ‰∏≠Êâæ‰∏çÂà∞ ID ‰∏∫', contextMenuNode, 'ÁöÑÊàêÂëò');
                console.log('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        member = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞ÊàêÂëò‰ø°ÊÅØ:', member);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(member);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            const content = `
                <div style="line-height: 1.8;">
                    <p><strong>ÂßìÂêçÔºö</strong>${member.full_name}</p>
                    <p><strong>ÊÄßÂà´Ôºö</strong>${member.gender === 'male' ? 'Áî∑' : 'Â•≥'}</p>
                    <p><strong>Âá∫ÁîüÊó•ÊúüÔºö</strong>${member.birth_date ? formatDate(member.birth_date) : 'Êú™Áü•'}</p>
                    ${member.birth_place ? '<p><strong>Âá∫ÁîüÂú∞ÁÇπÔºö</strong>' + member.birth_place + '</p>' : ''}
                    ${member.death_date ? '<p><strong>Âéª‰∏ñÊó•ÊúüÔºö</strong>' + formatDate(member.death_date) + '</p>' : ''}
                    ${member.burial_place || member.death_place ? '<p><strong>ÂüãËë¨Âú∞ÁÇπÔºö</strong>' + (member.burial_place || member.death_place) + '</p>' : ''}
                    <p><strong>ËÅå‰∏öÔºö</strong>${member.occupation || 'Êú™Â°´ÂÜô'}</p>
                    <p><strong>Â§áÊ≥®Ôºö</strong>${member.notes || 'Êó†'}</p>
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ÁºñËæëÈÄâ‰∏≠ÊàêÂëò
        async function editSelectedMember() {
            console.log('=== editSelectedMember Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÁºñËæëÊàêÂëò');
                return;
            }
            
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('Êü•ÊâæÊàêÂëò ID:', contextMenuNode);
            let member = allMembers.find(m => m.individual_id === contextMenuNode);
            console.log('ÊâæÂà∞ÁöÑÊàêÂëò:', member);
            
            if (!member) {
                console.error('Âú® allMembers ‰∏≠Êâæ‰∏çÂà∞ ID ‰∏∫', contextMenuNode, 'ÁöÑÊàêÂëò');
                console.log('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        member = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞ÊàêÂëò‰ø°ÊÅØ:', member);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(member);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            document.getElementById('modalTitle').textContent = 'ÁºñËæëÊàêÂëò‰ø°ÊÅØ';
            document.getElementById('editingId').value = member.individual_id;
            document.getElementById('fullName').value = member.full_name;
            document.getElementById('gender').value = member.gender;
            document.getElementById('birthDate').value = member.birth_date ? member.birth_date.split('T')[0] : '';
            document.getElementById('birthPlace').value = member.birth_place || '';
            document.getElementById('deathDate').value = member.death_date ? member.death_date.split('T')[0] : '';
            document.getElementById('burialPlace').value = member.burial_place || member.death_place || '';
            document.getElementById('occupation').value = member.occupation || '';
            document.getElementById('notes').value = member.notes || '';
            
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Âà†Èô§ÈÄâ‰∏≠ÊàêÂëò
        async function deleteSelectedMember() {
            console.log('=== deleteSelectedMember Ë¢´Ë∞ÉÁî® ===');
            console.log('contextMenuNode:', contextMenuNode);
            if (!contextMenuNode) {
                console.error('contextMenuNode ‰∏∫Á©∫ÔºåÊó†Ê≥ïÂà†Èô§ÊàêÂëò');
                return;
            }
            
            console.log('allMembers Êï∞ÁªÑÈïøÂ∫¶:', allMembers.length);
            console.log('Êü•ÊâæÊàêÂëò ID:', contextMenuNode);
            let member = allMembers.find(m => m.individual_id === contextMenuNode);
            console.log('ÊâæÂà∞ÁöÑÊàêÂëò:', member);
            
            if (!member) {
                console.error('Âú® allMembers ‰∏≠Êâæ‰∏çÂà∞ ID ‰∏∫', contextMenuNode, 'ÁöÑÊàêÂëò');
                console.log('allMembers ‰∏≠ÁöÑÊâÄÊúâID:', allMembers.map(m => m.individual_id));
                
                // Áõ¥Êé•‰ªéAPIËé∑ÂèñËØ•ÊàêÂëò‰ø°ÊÅØ
                console.log('Â∞ùËØï‰ªéAPIËé∑ÂèñÊàêÂëò‰ø°ÊÅØ...', contextMenuNode);
                try {
                    const apiUrl = `/api/v1/individuals/${contextMenuNode}?_=${Date.now()}`;
                    console.log('API URL:', apiUrl);
                    
                    const response = await fetch(apiUrl, {
                        headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                    });
                    
                    console.log('APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                    
                    const data = await response.json();
                    console.log('APIÂìçÂ∫îÊï∞ÊçÆ:', data);
                    
                    if (data.success && data.data) {
                        member = data.data;
                        console.log('‰ªéAPIËé∑ÂèñÂà∞ÊàêÂëò‰ø°ÊÅØ:', member);
                        
                        // Â∞ÜËØ•ÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑ‰∏≠ÔºåÈÅøÂÖç‰∏ãÊ¨°ÂÜçÊ¨°Êü•ËØ¢
                        allMembers.push(member);
                        console.log('Â∑≤Â∞ÜÊàêÂëòÊ∑ªÂä†Âà∞allMembersÊï∞ÁªÑÔºåÊñ∞ÈïøÂ∫¶:', allMembers.length);
                    } else {
                        console.error('APIËøîÂõûÂ§±Ë¥•:', data);
                        showNotification('Êó†Ê≥ïËé∑ÂèñÈÄâ‰∏≠ÊàêÂëòÁöÑ‰ø°ÊÅØ', 'error');
                        return;
                    }
                } catch (error) {
                    console.error('APIËØ∑Ê±ÇÂ§±Ë¥•:', error);
                    showNotification('ÁΩëÁªúÈîôËØØÔºåÊó†Ê≥ïËé∑ÂèñÊàêÂëò‰ø°ÊÅØ', 'error');
                    return;
                }
            }
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ ${member.full_name} ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`)) {
                return;
            }
            
            try {
                const response = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Âà†Èô§ÊàêÂäü', 'success');
                    await loadAllMembers();
                    if (currentRootId === contextMenuNode) {
                        currentRootId = null;
                        document.getElementById('treeContainer').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">üå±</div>
                                <div class="empty-state-text">ÈÄâÊã©‰∏Ä‰∏™ÊàêÂëòÊü•ÁúãÂÆ∂ÊóèÊ†ë</div>
                            </div>
                        `;
                    } else if (currentRootId) {
                        showFamilyTree(currentRootId);
                    }
                } else {
                    showNotification(data.message || 'Âà†Èô§Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showNotification('ÁΩëÁªúÈîôËØØ', 'error');
            }
            
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Â§ÑÁêÜË°®ÂçïÊèê‰∫§
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = getFormData();
            const editingId = document.getElementById('editingId').value;
            const parentType = document.getElementById('parentType').value;
            
            try {
                let response;
                
                if (editingId) {
                    // Êõ¥Êñ∞Áé∞ÊúâÊàêÂëò
                    response = await authenticatedFetch(`/api/v1/individuals/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // ÂàõÂª∫Êñ∞ÊàêÂëò
                    if (parentType === 'spouse' && contextMenuNode) {
                        // ÂÖàÂàõÂª∫ÈÖçÂÅ∂ÊàêÂëò
                        const createResponse = await authenticatedFetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // ÂàõÂª∫ÈÖçÂÅ∂ÂÖ≥Á≥ª
                            const spouseResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}/add-spouse`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    spouse_id: createData.data.individual_id
                                })
                            });
                            
                            const spouseData = await spouseResponse.json();
                            
                            if (spouseData.success) {
                                showNotification('ÈÖçÂÅ∂Ê∑ªÂä†ÊàêÂäü', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(spouseData.message || 'ÈÖçÂÅ∂ÂÖ≥Á≥ªÂàõÂª∫Â§±Ë¥•', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'ÈÖçÂÅ∂ÂàõÂª∫Â§±Ë¥•', 'error');
                            return;
                        }
                    } else if (parentType === 'child' && contextMenuNode) {
                        // ËÆæÁΩÆÁà∂ÊØçID
                        const parentMember = allMembers.find(m => m.individual_id === contextMenuNode);
                        console.log('Ê∑ªÂä†Â≠êÂ•≥ - Áà∂ÊØçÊàêÂëò:', parentMember);
                        
                        if (parentMember.gender === 'male') {
                            formData.father_id = contextMenuNode;
                            
                            // Ê£ÄÊü•ÊòØÂê¶ÈÄâÊã©‰∫ÜÁâπÂÆöÁöÑÂ¶ªÂ≠ê
                            const selectedWifeElement = document.getElementById('selectedWife');
                            const selectedWifeId = selectedWifeElement ? selectedWifeElement.value : '';
                            if (selectedWifeId) {
                                formData.mother_id = parseInt(selectedWifeId);
                                console.log('Ê∑ªÂä†Â≠êÂ•≥ - ÈÄâÊã©ÁöÑÊØç‰∫≤ID:', selectedWifeId);
                            } else {
                                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©ÔºåÂ∞ùËØïËá™Âä®ËÆæÁΩÆÔºàÂÖºÂÆπÂçïÂ¶ªÂ≠êÊÉÖÂÜµÔºâ
                                const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}/spouses?_=${Date.now()}`, {
                                    headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                                });
                                const spousesData = await spousesResponse.json();
                                const spouses = (spousesData.success && spousesData.data) ? spousesData.data : [];
                                
                                const wives = spouses.filter(spouse => spouse && spouse.gender === 'female');
                                if (wives.length === 1) {
                                    formData.mother_id = wives[0].individual_id;
                                } else if (wives.length > 1) {
                                    showNotification('ËØ∑ÈÄâÊã©Â≠©Â≠êÁöÑÊØç‰∫≤', 'warning');
                                    return;
                                }
                            }
                        } else if (parentMember.gender === 'female') {
                            formData.mother_id = contextMenuNode;
                            // Â¶ÇÊûúÊØç‰∫≤ÊúâÈÖçÂÅ∂ÔºåËá™Âä®ËÆæÁΩÆÁà∂‰∫≤
                            const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}/spouses?_=${Date.now()}`, {
                                headers: {'Cache-Control': 'no-cache', 'Pragma': 'no-cache'}
                            });
                            const spousesData = await spousesResponse.json();
                            const spouses = (spousesData.success && spousesData.data) ? spousesData.data : [];
                            
                            const husbands = spouses.filter(spouse => spouse && spouse.gender === 'male');
                            if (husbands.length > 0) {
                                // Â¶ÇÊûúÊúâÂ§ö‰∏™‰∏àÂ§´ÔºåÈÄâÊã©Á¨¨‰∏Ä‰∏™ÔºàÂú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÂèØËÉΩÈúÄË¶ÅÁî®Êà∑ÈÄâÊã©Ôºâ
                                formData.father_id = husbands[0].individual_id;
                            }
                        }
                        
                        console.log('Ê∑ªÂä†Â≠êÂ•≥ - ÊúÄÁªàË°®ÂçïÊï∞ÊçÆ:', formData);
                    } else if (parentType === 'father' && contextMenuNode) {
                        // Ê∑ªÂä†Áà∂‰∫≤ÔºöÂàõÂª∫Áà∂‰∫≤ÂêéÊõ¥Êñ∞Â≠êÂ•≥ÁöÑfather_id
                        console.log('Ê∑ªÂä†Áà∂‰∫≤ - Â≠êÂ•≥ID:', contextMenuNode);
                        
                        // ÂÖàÂàõÂª∫Áà∂‰∫≤
                        const createResponse = await authenticatedFetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // Êõ¥Êñ∞Â≠êÂ•≥ÁöÑfather_id
                            const childMember = allMembers.find(m => m.individual_id === contextMenuNode);
                            const updateData = {
                                ...childMember,
                                father_id: createData.data.individual_id
                            };
                            
                            const updateResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });
                            
                            const updateResult = await updateResponse.json();
                            
                            if (updateResult.success) {
                                showNotification('Áà∂‰∫≤Ê∑ªÂä†ÊàêÂäü', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(updateResult.message || 'Êõ¥Êñ∞Áà∂Â≠êÂÖ≥Á≥ªÂ§±Ë¥•', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'Áà∂‰∫≤ÂàõÂª∫Â§±Ë¥•', 'error');
                            return;
                        }
                    } else if (parentType === 'mother' && contextMenuNode) {
                        // Ê∑ªÂä†ÊØç‰∫≤ÔºöÂàõÂª∫ÊØç‰∫≤ÂêéÊõ¥Êñ∞Â≠êÂ•≥ÁöÑmother_id
                        console.log('Ê∑ªÂä†ÊØç‰∫≤ - Â≠êÂ•≥ID:', contextMenuNode);
                        
                        // ÂÖàÂàõÂª∫ÊØç‰∫≤
                        const createResponse = await authenticatedFetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // Êõ¥Êñ∞Â≠êÂ•≥ÁöÑmother_id
                            const childMember = allMembers.find(m => m.individual_id === contextMenuNode);
                            const updateData = {
                                ...childMember,
                                mother_id: createData.data.individual_id
                            };
                            
                            const updateResponse = await authenticatedFetch(`/api/v1/individuals/${contextMenuNode}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });
                            
                            const updateResult = await updateResponse.json();
                            
                            if (updateResult.success) {
                                showNotification('ÊØç‰∫≤Ê∑ªÂä†ÊàêÂäü', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(updateResult.message || 'Êõ¥Êñ∞ÊØçÂ≠êÂÖ≥Á≥ªÂ§±Ë¥•', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'ÊØç‰∫≤ÂàõÂª∫Â§±Ë¥•', 'error');
                            return;
                        }
                    }
                    
                    response = await authenticatedFetch('/api/v1/individuals', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(editingId ? 'Êõ¥Êñ∞ÊàêÂäü' : 'Ê∑ªÂä†ÊàêÂäü', 'success');
                    closeMemberModal();
                    await loadAllMembers();
                    
                    if (!currentRootId) {
                        // Â¶ÇÊûúÊòØÁ¨¨‰∏Ä‰∏™ÊàêÂëòÔºåËÆæ‰∏∫Ê†πËäÇÁÇπ
                        showFamilyTree(data.data.individual_id);
                    } else {
                        // Âà∑Êñ∞ÂΩìÂâçÊ†ë
                        showFamilyTree(currentRootId);
                    }
                } else {
                    showNotification(data.message || 'Êìç‰ΩúÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                console.error('Ë°®ÂçïÊèê‰∫§ÈîôËØØ:', error);
                showNotification('ÁΩëÁªúÈîôËØØ: ' + error.message, 'error');
            }
        }

        // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
        function getFormData() {
            const data = {
                full_name: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                occupation: document.getElementById('occupation').value || null,
                notes: document.getElementById('notes').value || null
            };
            
            const birthDate = document.getElementById('birthDate').value;
            if (birthDate) data.birth_date = birthDate + 'T00:00:00Z';
            
            const birthPlace = document.getElementById('birthPlace').value;
            if (birthPlace) data.birth_place = birthPlace;
            
            const deathDate = document.getElementById('deathDate').value;
            if (deathDate) data.death_date = deathDate + 'T00:00:00Z';
            
            const burialPlace = document.getElementById('burialPlace').value;
            if (burialPlace) {
                data.burial_place = burialPlace;
                data.death_place = burialPlace; // ÂÖºÂÆπÊÄß
            }
            
            return data;
        }

        // ÂÖ≥Èó≠ÊàêÂëòÊ®°ÊÄÅÊ°Ü
        function closeMemberModal() {
            document.getElementById('memberModal').style.display = 'none';
        }

        // ÂÖ≥Èó≠ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // ÊòæÁ§∫ÈÄöÁü•
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.getFullYear() + 'Âπ¥' + (date.getMonth() + 1) + 'Êúà' + date.getDate() + 'Êó•';
        }

        // Èò≤ÊäñÂáΩÊï∞
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ÊòæÁ§∫Êñ∞Áî®Êà∑Ê¨¢ËøéÁïåÈù¢
        function showNewUserWelcome() {
            const container = document.getElementById('treeContainer');
            const userName = currentUser ? currentUser.full_name || currentUser.username : 'Áî®Êà∑';
            
            const welcomeHtml = `
                <div class="new-user-welcome">
                    <div class="welcome-icon">üå≥</div>
                    <h2>Ê¨¢ËøéÊù•Âà∞ÂÆ∂ÊóèÊ†ëÁ≥ªÁªüÔºÅ</h2>
                    <p>‰∫≤Áà±ÁöÑ ${userName}ÔºåËÆ©Êàë‰ª¨ÂºÄÂßãÊûÑÂª∫ÊÇ®ÁöÑÂÆ∂ÊóèÊ†ëÂêßÔºÅ</p>
                    <div class="welcome-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h3>Ê∑ªÂä†Á¨¨‰∏Ä‰ΩçÊàêÂëò</h3>
                                <p>ÈÄöÂ∏∏Âª∫ËÆÆ‰ªéÊÇ®Ëá™Â∑±ÂºÄÂßãÔºåÊàñ‰ªéÊÇ®ÁöÑÁ•ñËæàÂºÄÂßã</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h3>Ê∑ªÂä†ÂÆ∂ÊóèÂÖ≥Á≥ª</h3>
                                <p>‰∏∫ÊàêÂëòÊ∑ªÂä†Áà∂ÊØç„ÄÅÈÖçÂÅ∂ÂíåÂ≠êÂ•≥ÂÖ≥Á≥ª</p>
                            </div>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h3>ÂÆåÂñÑ‰ø°ÊÅØ</h3>
                                <p>Ê∑ªÂä†ÁîüÊó•„ÄÅËÅå‰∏ö„ÄÅÁÖßÁâáÁ≠âËØ¶ÁªÜ‰ø°ÊÅØ</p>
                            </div>
                        </div>
                    </div>
                    <div class="welcome-actions">
                        <button class="btn btn-primary btn-large" onclick="showAddModal()">
                            <span class="btn-icon">üë§</span>
                            ÂàõÂª∫Á¨¨‰∏Ä‰ΩçÂÆ∂ÊóèÊàêÂëò
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = welcomeHtml;
            
            // Êõ¥Êñ∞Â§¥ÈÉ®Ê†áÈ¢ò
            document.getElementById('currentRootName').textContent = 'ÂºÄÂßãÊûÑÂª∫ÊÇ®ÁöÑÂÆ∂ÊóèÊ†ë';
            document.getElementById('currentGenInfo').textContent = '';
        }

        // Ê∏≤Êüì‰º†ÁªüÊóèË∞±Â∏ÉÂ±Ä
        async function renderTraditionalFamilyLayout(rootData) {
            if (!rootData || !rootData.individual) {
                return '<div class="empty-state"><div class="empty-state-icon">üå±</div><div class="empty-state-text">ÊöÇÊó†Êï∞ÊçÆ</div></div>';
            }
            
            let html = '<div class="traditional-family-layout">';
            
            // Ê∏≤ÊüìÁà∂ÊØçÂ±Ç
            html += '<div class="parents-row">';
            html += renderTreeNode(rootData.individual, 'root-node', 'Êú¨‰∫∫', false);
            
            if (rootData.spouses && rootData.spouses.length > 0) {
                rootData.spouses.forEach((spouse, index) => {
                    const wifeOrder = spouse.marriage_order || (index + 1);
                    let spouseLabel = 'ÈÖçÂÅ∂';
                    
                    if (rootData.individual.gender === 'male' && spouse.gender === 'female') {
                        spouseLabel = rootData.spouses.length > 1 ? `${spouse.full_name}` : 'Â¶ªÂ≠ê';
                    } else if (rootData.individual.gender === 'female' && spouse.gender === 'male') {
                        spouseLabel = '‰∏àÂ§´';
                    }
                    
                    html += '<div class="spouse-separator">|</div>';
                    html += renderTreeNode(spouse, 'spouse-node', spouseLabel, false);
                });
            }
            html += '</div>';
            
            // Â¶ÇÊûúÊúâÂ≠êÂ•≥ÔºåÊ∏≤ÊüìÂ≠êÂ•≥Â±Ç
            if (rootData.children && rootData.children.length > 0) {
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÂ§öÂ¶ªÂà∂ÊÉÖÂÜµ
                const wives = rootData.spouses ? rootData.spouses.filter(s => s.gender === 'female') : [];
                const shouldGroupByWife = wives.length > 1;
                
                if (shouldGroupByWife) {
                    html += await renderChildrenGroupedByWife(rootData, wives);
                } else {
                    html += await renderChildrenTraditionalLayout(rootData.children);
                }
            }
            
            html += '</div>';
            return html;
        }

        // ÊåâÂ¶ªÂ≠êÂàÜÁªÑÊ∏≤ÊüìÂ≠êÂ•≥Ôºà‰º†ÁªüÂ∏ÉÂ±ÄÔºâ
        async function renderChildrenGroupedByWife(rootData, wives) {
            let html = '<div class="wives-groups-layout">';
            
            try {
                // Ëé∑ÂèñÂÆ∂Â∫≠ÂÖ≥Á≥ªÊï∞ÊçÆ
                const familiesResponse = await authenticatedFetch(`/api/v1/families/husband/${rootData.individual.individual_id}`);
                const familiesData = await familiesResponse.json();
                const families = familiesData.success ? familiesData.data : [];
                
                // ‰∏∫ÊØè‰∏™Â¶ªÂ≠êÂàõÂª∫‰∏Ä‰∏™ÁªÑ
                for (const wife of wives) {
                    const family = families.find(f => f.wife_id === wife.individual_id);
                    const wifeOrder = family ? family.marriage_order : 1;
                    const wifeChildren = rootData.children.filter(child => child.individual.mother_id === wife.individual_id);
                    
                    if (wifeChildren.length > 0) {
                        const wifeColor = getWifeColor(wife.individual_id, wives);
                        
                        html += `<div class="wife-group" style="border-color: ${wifeColor};">`;
                        html += `<div class="wife-group-header" style="border-color: ${wifeColor}; color: ${wifeColor};">`;
                        html += `${wife.full_name}ÔºàÁ¨¨${wifeOrder}‰ªªÂ¶ªÂ≠êÔºâÊâÄÁîüÂ≠êÂ•≥`;
                        html += '</div>';
                        
                        html += '<div class="wife-children-traditional">';
                        html += await renderChildrenTraditionalLayout(wifeChildren, wifeColor);
                        html += '</div>';
                        
                        html += '</div>';
                    }
                }
                
            } catch (error) {
                console.error('Ëé∑ÂèñÂÆ∂Â∫≠ÂÖ≥Á≥ªÂ§±Ë¥•:', error);
                html += await renderChildrenTraditionalLayout(rootData.children);
            }
            
            html += '</div>';
            return html;
        }

        // Ê∏≤Êüì‰º†ÁªüÂ∏ÉÂ±ÄÁöÑÂ≠êÂ•≥
        async function renderChildrenTraditionalLayout(children, groupColor = '#4CAF50') {
            if (!children || children.length === 0) {
                return '';
            }
            
            let html = '<div class="children-connection-area">';
            
            // ‰∏ªÂûÇÁõ¥ËøûÊé•Á∫ø
            html += '<div class="main-vertical-line"></div>';
            
            // Ê∞¥Âπ≥ËøûÊé•Á∫øÔºàÂ¶ÇÊûúÊúâÂ§ö‰∏™Â≠êÂ•≥Ôºâ
            if (children.length > 1) {
                html += `<div class="horizontal-connector" style="background: ${groupColor}; width: ${Math.min(children.length * 180, 800)}px;"></div>`;
            }
            
            // Â≠êÂ•≥ËäÇÁÇπ
            html += '<div class="children-with-lines">';
            
            // ÊåâÂá∫ÁîüÈ°∫Â∫èÊéíÂ∫è
            const sortedChildren = [...children].sort((a, b) => {
                const aDate = a.individual.birth_date ? new Date(a.individual.birth_date) : new Date(0);
                const bDate = b.individual.birth_date ? new Date(b.individual.birth_date) : new Date(0);
                return aDate - bDate;
            });
            
            for (let i = 0; i < sortedChildren.length; i++) {
                const child = sortedChildren[i];
                const orderLabels = ['Èïø', 'Ê¨°', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠', '‰∏É', 'ÂÖ´', '‰πù', 'ÂçÅ'];
                const orderLabel = i < orderLabels.length ? orderLabels[i] : `Á¨¨${i + 1}`;
                const genderSuffix = child.individual.gender === 'male' ? 'Â≠ê' : 'Â•≥';
                
                html += '<div class="child-with-line">';
                
                // ÂûÇÁõ¥ËøûÊé•Á∫ø
                if (children.length > 1) {
                    html += `<div class="child-vertical-line" style="background: ${groupColor};"></div>`;
                }
                
                // ÊéíÂ∫èÊ†áÁ≠æ
                html += `<div class="child-order-label">${orderLabel}${genderSuffix}</div>`;
                
                // Â≠êÂ•≥ËäÇÁÇπ
                html += '<div class="family-group">';
                html += renderTreeNode(child.individual, 'child-node', `${orderLabel}${genderSuffix}`, false);
                
                // Ëé∑ÂèñÂ≠êÂ•≥ÁöÑÈÖçÂÅ∂
                try {
                    const spousesResponse = await authenticatedFetch(`/api/v1/individuals/${child.individual.individual_id}/spouses`);
                    const spousesData = await spousesResponse.json();
                    
                    if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                        spousesData.data.forEach(spouse => {
                            html += '<div class="marriage-connector">üíï</div>';
                            html += renderTreeNode(spouse, 'child-node spouse-node', 'ÈÖçÂÅ∂', false);
                        });
                    }
                } catch (error) {
                    console.error('Ëé∑ÂèñÂ≠êÂ•≥ÈÖçÂÅ∂‰ø°ÊÅØÂ§±Ë¥•:', error);
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            html += '</div>';
            
            return html;
        }

        // Ëé∑ÂèñÂ¶ªÂ≠êÂØπÂ∫îÁöÑÈ¢úËâ≤
        function getWifeColor(wifeId, wives) {
            const colors = ['#ff6b9d', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#fd79a8', '#00b894'];
            const index = wives.findIndex(w => w.individual_id === wifeId);
            return colors[index % colors.length];
        }


    </script>
</body>
</html> 