<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—æ ‘ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 1.8em;
            font-weight: 600;
        }

        .search-container {
            flex: 1;
            max-width: 400px;
            margin: 0 30px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: white;
        }

        .search-input:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: #4CAF50;
            border: none;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-btn:hover {
            background: #45a049;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 200;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-result-item:hover {
            background: #f8f9fa;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .family-tree-main {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            min-height: 600px;
        }

        .tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tree-title {
            font-size: 1.5em;
            color: #333;
            font-weight: 600;
        }

        .tree-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .generations-select {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            outline: none;
            font-size: 14px;
        }

        .add-root-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .add-root-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .tree-container {
            background: #fafafa;
            border-radius: 10px;
            padding: 30px;
            overflow: auto;
            min-height: 500px;
            position: relative;
        }

        .tree-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 20px;
            min-height: 100vh;
            overflow-x: auto;
        }

        .tree-generation {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            min-height: 120px;
            width: 100%;
        }

        .tree-node {
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            padding: 15px;
            min-width: 140px;
            max-width: 200px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        /* ç´§å‡‘æ¨¡å¼ - åªæ˜¾ç¤ºå§“å */
        .tree-node.compact {
            padding: 10px;
            min-width: 100px;
            max-width: 120px;
            font-size: 0.9em;
        }

        .tree-node.compact .node-details,
        .tree-node.compact .node-occupation {
            display: none;
        }

        .tree-node:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .tree-node.selected {
            background: #4CAF50;
            color: white;
            transform: scale(1.05);
        }

        .ancestor-node {
            border-color: #607D8B;
            background: #eceff1;
        }

        .root-node {
            border-color: #2196F3;
            background: #e3f2fd;
            border-width: 4px;
            transform: scale(1.05);
        }

        .spouse-node {
            border-color: #E91E63;
            background: #fce4ec;
        }

        .child-node {
            border-color: #FF9800;
            background: #fff3e0;
        }

        .descendant-node {
            border-color: #9C27B0;
            background: #f3e5f5;
        }

        .node-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.2;
        }

        .node-details {
            font-size: 0.8em;
            color: #666;
            margin: 3px 0;
            line-height: 1.3;
        }

        .node-occupation {
            font-size: 0.75em;
            color: #888;
            font-style: italic;
            margin-top: 5px;
        }

        .marriage-connector {
            display: flex;
            align-items: center;
            font-size: 1.5em;
            margin: 0 10px;
            color: #E91E63;
            flex-shrink: 0;
        }

        .family-group {
            display: flex;
            align-items: center;
            margin: 0 5px;
            flex-wrap: nowrap;
        }

        /* å¤šå¦»å­æ˜¾ç¤ºæ ·å¼ */
        .spouses-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .spouse-separator {
            color: #ccc;
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 5px;
        }

        /* æ”¹è¿›çš„è¿æ¥çº¿æ ·å¼ */
        .generation-with-connections {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .connection-lines {
            position: relative;
            width: 100%;
            height: 40px;
            margin-bottom: 10px;
        }

        .horizontal-line {
            position: absolute;
            height: 2px;
            background: #4CAF50;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-line {
            position: absolute;
            width: 2px;
            background: #4CAF50;
            top: 0;
            height: 100%;
        }

        .children-row {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 15px;
            flex-wrap: wrap;
            width: 100%;
        }

        .child-with-mother-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .mother-indicator {
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 8px;
            padding: 3px 8px;
            border-radius: 12px;
            border: 2px solid;
            background: white;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .mothers-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .mother-info {
            font-size: 0.7em;
            font-weight: bold;
            margin-top: 5px;
            padding: 2px 6px;
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            text-align: center;
            border: 1px solid;
        }

        .tree-node.compact .mother-info {
            font-size: 0.6em;
            padding: 1px 4px;
            margin-top: 3px;
        }

        .connection-line-to-mother {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            z-index: 1;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .tree-node {
                min-width: 120px;
                max-width: 150px;
                padding: 12px;
            }
            
            .tree-node.compact {
                min-width: 90px;
                max-width: 110px;
                padding: 8px;
            }
            
            .marriage-connector {
                font-size: 1.2em;
                margin: 0 5px;
            }
        }

        @media (max-width: 768px) {
            .tree-generation {
                gap: 10px;
            }
            
            .tree-node {
                min-width: 100px;
                max-width: 130px;
                padding: 10px;
                font-size: 0.9em;
            }
            
            .tree-node.compact {
                min-width: 80px;
                max-width: 100px;
                padding: 6px;
                font-size: 0.8em;
            }
        }

        .tree-connector {
            width: 3px;
            height: 40px;
            background: #4CAF50;
            margin: 0 auto;
        }

        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            padding: 8px 0;
            z-index: 1000;
            display: none;
            min-width: 180px;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: #f8f9fa;
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #f0f0f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 3000;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            background: #4CAF50;
        }

        .notification.error {
            background: #f44336;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.2em;
            margin-bottom: 30px;
        }

        /* ä¼ ç»Ÿæ—è°±å¸ƒå±€æ ·å¼ */
        .traditional-family-layout {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            position: relative;
        }

        .parents-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            position: relative;
        }

        .children-connection-area {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-vertical-line {
            width: 3px;
            height: 40px;
            background: #4CAF50;
            margin: 0 auto;
            position: relative;
        }

        .horizontal-connector {
            width: 100%;
            height: 3px;
            background: #4CAF50;
            position: relative;
            margin: 0 auto;
        }

        .children-with-lines {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 40px;
            position: relative;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .child-with-line {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .child-vertical-line {
            width: 3px;
            height: 30px;
            background: #4CAF50;
            margin-bottom: 10px;
        }

        .child-order-label {
            font-size: 0.7em;
            font-weight: bold;
            color: #666;
            margin-bottom: 5px;
            padding: 2px 6px;
            background: #f0f0f0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .birth-order-indicator {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6em;
            font-weight: bold;
            color: #2196F3;
            background: white;
            padding: 2px 6px;
            border-radius: 10px;
            border: 1px solid #2196F3;
            white-space: nowrap;
        }

        /* è¿æ¥çº¿è®¡ç®— */
        .children-connector-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            pointer-events: none;
        }

        .horizontal-line-segment {
            position: absolute;
            height: 3px;
            background: #4CAF50;
            top: 50%;
            transform: translateY(-50%);
        }

        .vertical-line-segment {
            position: absolute;
            width: 3px;
            background: #4CAF50;
            top: 0;
            height: 100%;
        }

        /* å¦»å­åˆ†ç»„æ˜¾ç¤º */
        .wives-groups-layout {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
        }

        .wife-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid #e8f4f8;
            border-radius: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8fdff 0%, #f0f9ff 100%);
            position: relative;
        }

        .wife-group-header {
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 15px;
            padding: 8px 15px;
            background: white;
            border-radius: 20px;
            border: 2px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .wife-children-traditional {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <h1>ğŸŒ³ å®¶æ—æ ‘</h1>
            </div>
            
            <!-- æœç´¢æ¡† -->
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢å®¶æ—æˆå‘˜...">
                <button class="search-btn" onclick="performSearch()">ğŸ”</button>
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-container">
        <div class="family-tree-main">
            <div class="tree-header">
                <div class="tree-title">
                    <span id="currentRootName">å®¶æ—æ ‘</span>
                    <span id="currentGenInfo" style="font-size: 0.7em; color: #666; margin-left: 10px;"></span>
                </div>
                <div class="tree-controls">
                    <button onclick="showFamilyTree(currentRootId)" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°
                    </button>
                    <button onclick="toggleLayout()" class="btn btn-secondary" id="layoutToggle">
                        <i class="fas fa-sitemap"></i> ä¼ ç»Ÿå¸ƒå±€
                    </button>
                    <select id="generationSelect" onchange="changeGenerations()" class="form-control" style="width: auto; display: inline-block;">
                        <option value="2">æ˜¾ç¤º2ä»£</option>
                        <option value="3" selected>æ˜¾ç¤º3ä»£</option>
                        <option value="4">æ˜¾ç¤º4ä»£</option>
                        <option value="5">æ˜¾ç¤º5ä»£</option>
                    </select>
                </div>
            </div>
            
            <!-- æ—è°±æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="tree-container" id="treeContainer">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸŒ±</div>
                    <div class="empty-state-text">å¼€å§‹æ„å»ºæ‚¨çš„å®¶æ—æ ‘</div>
                    <button class="btn btn-primary" onclick="showAddModal()">æ·»åŠ ç¬¬ä¸€ä½æˆå‘˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="showAddChildModal()">ğŸ‘¶ æ·»åŠ å­å¥³</div>
        <div class="context-menu-item" onclick="showAddSpouseModal()">ğŸ’‘ æ·»åŠ é…å¶</div>
        <div class="context-menu-item" onclick="showAddFatherModal()">ğŸ‘¨ æ·»åŠ çˆ¶äº²</div>
        <div class="context-menu-item" onclick="showAddMotherModal()">ğŸ‘© æ·»åŠ æ¯äº²</div>
        <div class="context-menu-item" onclick="showViewDetailsModal()">ğŸ“‹ æŸ¥çœ‹è¯¦æƒ…</div>
        <div class="context-menu-item" onclick="editSelectedMember()">âœï¸ ç¼–è¾‘ä¿¡æ¯</div>
        <div class="context-menu-item danger" onclick="deleteSelectedMember()">ğŸ—‘ï¸ åˆ é™¤æˆå‘˜</div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘æˆå‘˜æ¨¡æ€æ¡† -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">æ·»åŠ æˆå‘˜</div>
                <span class="close" onclick="closeMemberModal()">&times;</span>
            </div>
            
            <form id="memberForm">
                <input type="hidden" id="editingId" value="">
                <input type="hidden" id="parentType" value="">
                
                <div class="form-group">
                    <label for="fullName">å§“å *</label>
                    <input type="text" id="fullName" required>
                </div>
                
                <div class="form-group">
                    <label for="gender">æ€§åˆ« *</label>
                    <select id="gender" required>
                        <option value="">è¯·é€‰æ‹©æ€§åˆ«</option>
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="birthDate">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birthDate">
                </div>
                
                <div class="form-group">
                    <label for="birthPlace">å‡ºç”Ÿåœ°ç‚¹</label>
                    <input type="text" id="birthPlace" placeholder="å¦‚ï¼šåŒ—äº¬å¸‚æœé˜³åŒº">
                </div>
                
                <div class="form-group">
                    <label for="deathDate">å»ä¸–æ—¥æœŸ</label>
                    <input type="date" id="deathDate">
                </div>
                
                <div class="form-group">
                    <label for="burialPlace">åŸ‹è‘¬åœ°ç‚¹</label>
                    <input type="text" id="burialPlace" placeholder="å¦‚ï¼šåŒ—äº¬å¸‚æ˜Œå¹³åŒºå¢“å›­">
                </div>
                
                <div class="form-group">
                    <label for="occupation">èŒä¸š</label>
                    <input type="text" id="occupation">
                </div>
                
                <div class="form-group">
                    <label for="notes">å¤‡æ³¨</label>
                    <textarea id="notes" rows="3"></textarea>
                </div>
                
                <!-- æ¯äº²é€‰æ‹©ç»„ -->
                <div class="form-group" id="wifeSelectionGroup" style="display: none;">
                    <label for="selectedWife">é€‰æ‹©æ¯äº²:</label>
                    <select id="selectedWife" name="selectedWife">
                        <option value="">è¯·é€‰æ‹©æ¯äº²</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">æˆå‘˜è¯¦æƒ…</div>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div id="detailsContent"></div>
        </div>
    </div>

    <!-- é€šçŸ¥ç»„ä»¶ -->
    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let allMembers = [];
        let currentRootId = null;
        let currentGenerations = 3;
        let selectedNodeId = null;
        let contextMenuNode = null;
        let isTraditionalLayout = false; // å¸ƒå±€æ¨¡å¼æ ‡å¿—

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadAllMembers();
            initializeEventListeners();
        });

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        function initializeEventListeners() {
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('searchInput').addEventListener('focus', handleSearchFocus);
            document.getElementById('searchInput').addEventListener('blur', handleSearchBlur);
            
            // ç‚¹å‡»ç©ºç™½å¤„å…³é—­æœç´¢ç»“æœå’Œå³é”®èœå•
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
                if (!e.target.closest('.context-menu')) {
                    document.getElementById('contextMenu').style.display = 'none';
                }
            });

            // å³é”®èœå•äº‹ä»¶
            document.addEventListener('contextmenu', function(e) {
                if (e.target.closest('.tree-node')) {
                    e.preventDefault();
                    showContextMenu(e, e.target.closest('.tree-node'));
                }
            });

            // è¡¨å•æäº¤äº‹ä»¶
            document.getElementById('memberForm').addEventListener('submit', handleFormSubmit);
        }

        // åŠ è½½æ‰€æœ‰æˆå‘˜æ•°æ®
        async function loadAllMembers() {
            try {
                const response = await fetch('/api/v1/individuals');
                const data = await response.json();
                
                if (data.success) {
                    allMembers = data.data || [];
                    if (allMembers.length > 0) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰æå¯Œè´µ(ID:12)ï¼Œä¼˜å…ˆæ˜¾ç¤ºä¸€å¤«å¤šå¦»çš„æ¼”ç¤º
                        const polygamyDemo = allMembers.find(m => m.individual_id === 12);
                        const defaultId = polygamyDemo ? 12 : allMembers[0].individual_id;
                        showFamilyTree(defaultId);
                        
                        // å¦‚æœæ˜¾ç¤ºæå¯Œè´µï¼Œæç¤ºç”¨æˆ·è¿™æ˜¯ä¸€å¤«å¤šå¦»æ¼”ç¤º
                        if (polygamyDemo && defaultId === 12) {
                            setTimeout(() => {
                                showNotification('ğŸ¯ æ­£åœ¨æ˜¾ç¤ºæå¯Œè´µçš„ä¸€å¤«å¤šå¦»å®¶æ—æ ‘æ¼”ç¤º', 'success');
                            }, 1000);
                        }
                    }
                } else {
                    showNotification('åŠ è½½æˆå‘˜æ•°æ®å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½æˆå‘˜æ•°æ®å¤±è´¥:', error);
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æœç´¢å¤„ç†
        function handleSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 1) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            const results = allMembers.filter(member => 
                member.full_name.includes(query) || 
                (member.notes && member.notes.includes(query)) ||
                (member.occupation && member.occupation.includes(query))
            );

            displaySearchResults(results);
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item">æœªæ‰¾åˆ°åŒ¹é…çš„æˆå‘˜</div>';
            } else {
                container.innerHTML = results.map(member => `
                    <div class="search-result-item ${member.individual_id === 12 ? 'polygamy-demo' : ''}" onclick="selectSearchResult(${member.individual_id})">
                        <strong>${member.full_name}${member.individual_id === 12 ? ' ğŸ”¥ä¸€å¤«å¤šå¦»æ¼”ç¤º' : ''}</strong>
                        <div style="font-size: 0.85em; color: #666;">
                            ${member.gender === 'male' ? 'â™‚' : 'â™€'} 
                            ${member.occupation || ''} 
                            ${member.birth_date ? formatDate(member.birth_date) : ''}
                        </div>
                    </div>
                `).join('');
            }
            
            container.style.display = 'block';
        }

        // é€‰æ‹©æœç´¢ç»“æœ
        function selectSearchResult(memberId) {
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchInput').value = '';
            showFamilyTree(memberId);
        }

        // æœç´¢æ¡†ç„¦ç‚¹äº‹ä»¶
        function handleSearchFocus() {
            if (allMembers.length > 0) {
                displaySearchResults(allMembers.slice(0, 5)); // æ˜¾ç¤ºå‰5ä¸ªæˆå‘˜
            }
        }

        // æœç´¢æ¡†å¤±ç„¦äº‹ä»¶
        function handleSearchBlur() {
            setTimeout(() => {
                document.getElementById('searchResults').style.display = 'none';
            }, 200);
        }

        // æ‰§è¡Œæœç´¢
        function performSearch() {
            handleSearch();
        }

        // åˆ‡æ¢å¸ƒå±€æ¨¡å¼
        function toggleLayout() {
            isTraditionalLayout = !isTraditionalLayout;
            const toggleButton = document.getElementById('layoutToggle');
            
            if (isTraditionalLayout) {
                toggleButton.innerHTML = '<i class="fas fa-project-diagram"></i> ç°ä»£å¸ƒå±€';
                toggleButton.className = 'btn btn-success';
            } else {
                toggleButton.innerHTML = '<i class="fas fa-sitemap"></i> ä¼ ç»Ÿå¸ƒå±€';
                toggleButton.className = 'btn btn-secondary';
            }
            
            // é‡æ–°æ¸²æŸ“å½“å‰æ—è°±
            if (currentRootId) {
                showFamilyTree(currentRootId);
            }
        }

        // æ˜¾ç¤ºå®¶æ—æ ‘
        async function showFamilyTree(rootId) {
            if (!rootId) return;
            
            currentRootId = rootId;
            
            try {
                // è·å–å®¶æ—æ ‘æ•°æ®
                const response = await fetch(`/api/v1/individuals/${rootId}/family-tree?generations=${currentGenerations}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    // è·å–çˆ¶æ¯å’Œé…å¶ä¿¡æ¯
                    const [parentsRes, spousesRes] = await Promise.all([
                        fetch(`/api/v1/individuals/${rootId}/parents`),
                        fetch(`/api/v1/individuals/${rootId}/spouses`)
                    ]);
                    
                    const [parentsData, spousesData] = await Promise.all([
                        parentsRes.json(),
                        spousesRes.json()
                    ]);
                    
                    const enrichedData = {
                        ...data.data,
                        parents: parentsData.success ? parentsData.data : [],
                        spouses: spousesData.success ? spousesData.data : []
                    };
                    
                    console.log('å®¶æ—æ ‘æ•°æ®:', enrichedData);
                    console.log('é…å¶æ•°æ®:', spousesData);
                    
                    await displayFamilyTree(enrichedData);
                    updateTreeHeader(data.data.individual);
                } else {
                    showNotification('æ— æ³•åŠ è½½å®¶æ—æ ‘æ•°æ®', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½å®¶æ—æ ‘å¤±è´¥:', error);
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
        }

        // æ¸²æŸ“å®¶æ—æ ‘
        async function displayFamilyTree(treeData) {
            const container = document.getElementById('treeContainer');
            
            if (isTraditionalLayout) {
                container.innerHTML = await renderTraditionalFamilyLayout(treeData);
            } else {
                container.innerHTML = await renderFamilyTree(treeData);
            }
        }

        // æ¸²æŸ“å®¶æ—æ ‘
        async function renderFamilyTree(rootData) {
            if (!rootData || !rootData.individual) {
                return '<div class="empty-state"><div class="empty-state-icon">ğŸŒ±</div><div class="empty-state-text">æš‚æ— æ•°æ®</div></div>';
            }
            
            let html = '<div class="tree-wrapper">';
            
            // è®¡ç®—æ˜¯å¦éœ€è¦ç´§å‡‘æ˜¾ç¤º
            const totalParents = rootData.parents ? rootData.parents.length : 0;
            const totalSpouses = rootData.spouses ? rootData.spouses.length : 0;
            const totalChildren = rootData.children ? rootData.children.length : 0;
            const shouldUseCompactForParents = totalParents > 4;
            const shouldUseCompactForSpouses = totalSpouses > 3;
            
            // æ¸²æŸ“çˆ¶æ¯åŠå…¶é…å¶
            if (rootData.parents && rootData.parents.length > 0) {
                html += '<div class="tree-generation">';
                
                // è·å–çˆ¶æ¯çš„é…å¶ä¿¡æ¯
                for (const parent of rootData.parents) {
                    html += renderTreeNode(parent, 'ancestor-node', 'çˆ¶æ¯', shouldUseCompactForParents);
                    
                    // è·å–çˆ¶æ¯çš„é…å¶
                    try {
                        const spousesResponse = await fetch(`/api/v1/individuals/${parent.individual_id}/spouses`);
                        const spousesData = await spousesResponse.json();
                        
                        if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                            spousesData.data.forEach(spouse => {
                                // é¿å…é‡å¤æ˜¾ç¤ºå·²ç»æ˜¾ç¤ºçš„çˆ¶æ¯
                                if (!rootData.parents.some(p => p.individual_id === spouse.individual_id)) {
                                    html += '<div class="marriage-connector">ğŸ’•</div>';
                                    html += renderTreeNode(spouse, 'ancestor-node', 'çˆ¶æ¯', shouldUseCompactForParents);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('è·å–çˆ¶æ¯é…å¶ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
                
                html += '</div>';
                html += '<div class="tree-connector"></div>';
            }
            
            // æ¸²æŸ“æ ¹èŠ‚ç‚¹å’Œé…å¶ï¼ˆæ”¯æŒä¸€å¤«å¤šå¦»ï¼‰
            html += '<div class="tree-generation">';
            html += renderTreeNode(rootData.individual, 'root-node', 'æœ¬äºº', false); // æ ¹èŠ‚ç‚¹å§‹ç»ˆä¸ç´§å‡‘
            
            if (rootData.spouses && rootData.spouses.length > 0) {
                html += '<div class="marriage-connector">ğŸ’•</div>';
                html += '<div class="spouses-group">';
                for (let i = 0; i < rootData.spouses.length; i++) {
                    const spouse = rootData.spouses[i];
                    if (i > 0) html += '<div class="spouse-separator">|</div>';
                    
                    // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ marriage_order
                    const wifeOrder = spouse.marriage_order || 1;
                    let spouseLabel = 'é…å¶';
                    
                    if (rootData.individual.gender === 'male' && spouse.gender === 'female') {
                        spouseLabel = wifeOrder > 1 ? `ç¬¬${wifeOrder}ä»»å¦»å­` : 'å¦»å­';
                    } else if (rootData.individual.gender === 'female' && spouse.gender === 'male') {
                        spouseLabel = 'ä¸ˆå¤«';
                    }
                    
                    html += renderTreeNode(spouse, 'spouse-node', spouseLabel, shouldUseCompactForSpouses);
                }
                html += '</div>';
            }
            html += '</div>';
            
            // æ¸²æŸ“åä»£ï¼ˆæŒ‰å¦»å­åˆ†ç»„ï¼‰
            if (rootData.children && rootData.children.length > 0) {
                html += '<div class="tree-connector"></div>';
                html += await renderDescendantsByWife(rootData, 1);
            }
            
            html += '</div>';
            return html;
        }

        // è·å–å¦»å­é¡ºåº
        async function getWifeOrder(husbandId, wifeId) {
            try {
                const response = await fetch(`/api/v1/families/husband/${husbandId}`);
                const data = await response.json();
                if (data.success && data.data) {
                    const family = data.data.find(f => f.wife_id === wifeId);
                    return family ? family.marriage_order : 1;
                }
            } catch (error) {
                console.error('è·å–å¦»å­é¡ºåºå¤±è´¥:', error);
            }
            return 1;
        }

        // æŒ‰å¦»å­åˆ†ç»„æ¸²æŸ“åä»£ï¼ˆç”¨çº¿æ¡è¿æ¥ï¼‰
        async function renderDescendantsByWife(rootData, generation) {
            let html = '';
            
            if (!rootData.children || rootData.children.length === 0) {
                return html;
            }
            
            const nodeClass = generation === 1 ? 'child-node' : 'descendant-node';
            const label = generation === 1 ? 'å­å¥³' : `ç¬¬${generation + 1}ä»£`;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦ç´§å‡‘æ˜¾ç¤ºï¼ˆè¶…è¿‡6ä¸ªäººï¼‰
            const shouldUseCompact = rootData.children.length > 6;
            
            // å¦‚æœæ ¹èŠ‚ç‚¹æ˜¯ç”·æ€§ä¸”æœ‰é…å¶ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨çº¿æ¡è¿æ¥æ˜¾ç¤ºå­å¥³
            if (rootData.individual.gender === 'male' && rootData.spouses && rootData.spouses.length > 0) {
                const wives = rootData.spouses.filter(s => s.gender === 'female');
                const uniqueMothers = [...new Set(rootData.children.map(c => c.individual.mother_id).filter(id => id))];
                const shouldShowConnections = wives.length > 1 || uniqueMothers.length > 1;
                
                if (shouldShowConnections) {
                    try {
                        const familiesResponse = await fetch(`/api/v1/families/husband/${rootData.individual.individual_id}`);
                        const familiesData = await familiesResponse.json();
                        const families = familiesData.success ? familiesData.data : [];
                        
                        // åˆ›å»ºå¦»å­åˆ°é¢œè‰²çš„æ˜ å°„
                        const wifeColors = ['#ff6b9d', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#fd79a8', '#00b894'];
                        const wifeToColor = {};
                        let colorIndex = 0;
                        
                        wives.forEach(wife => {
                            wifeToColor[wife.individual_id] = wifeColors[colorIndex % wifeColors.length];
                            colorIndex++;
                        });
                        
                        html += '<div class="generation-with-connections">';
                        
                        // æ¸²æŸ“æ¯äº²æŒ‡ç¤ºå™¨
                        if (wives.length > 1) {
                            html += '<div class="mothers-indicators" style="display: flex; justify-content: center; gap: 20px; margin-bottom: 15px;">';
                            wives.forEach(wife => {
                                const family = families.find(f => f.wife_id === wife.individual_id);
                                const wifeOrder = family ? family.marriage_order : 1;
                                const wifeLabel = wifeOrder > 1 ? `ç¬¬${wifeOrder}ä»»å¦»å­` : 'å¦»å­';
                                const color = wifeToColor[wife.individual_id];
                                html += `<div class="mother-indicator" style="color: ${color}; border-color: ${color};">${wife.full_name}(${wifeLabel})</div>`;
                            });
                            html += '</div>';
                        }
                        
                        // æ¸²æŸ“æ‰€æœ‰å­å¥³åœ¨åŒä¸€å±‚
                        html += '<div class="children-row">';
                        
                        for (const child of rootData.children) {
                            const motherId = child.individual.mother_id;
                            const mother = wives.find(w => w.individual_id === motherId);
                            const family = families.find(f => f.wife_id === motherId);
                            const wifeOrder = family ? family.marriage_order : 1;
                            const wifeLabel = wifeOrder > 1 ? `ç¬¬${wifeOrder}ä»»` : '';
                            const connectionColor = mother ? wifeToColor[motherId] : '#ccc';
                            
                            html += '<div class="child-with-mother-info">';
                            
                            // è¿æ¥çº¿åˆ°æ¯äº²
                            if (mother && wives.length > 1) {
                                html += `<div class="connection-line-to-mother" style="background: ${connectionColor};"></div>`;
                            }
                            
                            // å­å¥³èŠ‚ç‚¹
                            html += '<div class="family-group">';
                            html += renderTreeNodeWithConnection(
                                child.individual, 
                                nodeClass, 
                                label, 
                                connectionColor, 
                                mother && wives.length > 1 ? `${wifeLabel}${mother.full_name}` : '', 
                                shouldUseCompact
                            );
                            
                            // è·å–å­å¥³çš„é…å¶
                            try {
                                const spousesResponse = await fetch(`/api/v1/individuals/${child.individual.individual_id}/spouses`);
                                const spousesData = await spousesResponse.json();
                                
                                if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                                    spousesData.data.forEach(spouse => {
                                        html += '<div class="marriage-connector">ğŸ’•</div>';
                                        html += renderTreeNode(spouse, nodeClass + ' spouse-node', label === 'å­å¥³' ? 'é…å¶' : 'é…å¶', shouldUseCompact);
                                    });
                                }
                            } catch (error) {
                                console.error('è·å–å­å¥³é…å¶ä¿¡æ¯å¤±è´¥:', error);
                            }
                            
                            html += '</div>';
                            html += '</div>';
                        }
                        
                        html += '</div>';
                        html += '</div>';
                        
                    } catch (error) {
                        console.error('è·å–å®¶åº­å…³ç³»å¤±è´¥:', error);
                        html += await renderDescendants(rootData.children, generation, shouldUseCompact);
                    }
                } else {
                    html += await renderDescendants(rootData.children, generation, shouldUseCompact);
                }
            } else {
                html += await renderDescendants(rootData.children, generation, shouldUseCompact);
            }
            
            return html;
        }

        // æ¸²æŸ“åä»£
        async function renderDescendants(children, generation, compact = false) {
            let html = '';
            
            if (children.length > 0) {
                const nodeClass = generation === 1 ? 'child-node' : 'descendant-node';
                const label = generation === 1 ? 'å­å¥³' : `ç¬¬${generation + 1}ä»£`;
                
                html += '<div class="tree-generation">';
                
                // æ¸²æŸ“å­å¥³åŠå…¶é…å¶
                for (const child of children) {
                    // åˆ›å»ºä¸€ä¸ªåŒ…å«å­å¥³å’Œé…å¶çš„å®¶åº­ç»„
                    html += '<div class="family-group">';
                    html += renderTreeNode(child.individual, nodeClass, label, compact);
                    
                    // è·å–å­å¥³çš„é…å¶
                    try {
                        const spousesResponse = await fetch(`/api/v1/individuals/${child.individual.individual_id}/spouses`);
                        const spousesData = await spousesResponse.json();
                        
                        if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                            spousesData.data.forEach(spouse => {
                                html += '<div class="marriage-connector">ğŸ’•</div>';
                                html += renderTreeNode(spouse, nodeClass + ' spouse-node', label === 'å­å¥³' ? 'é…å¶' : 'é…å¶', compact);
                            });
                        }
                    } catch (error) {
                        console.error('è·å–å­å¥³é…å¶ä¿¡æ¯å¤±è´¥:', error);
                    }
                    
                    html += '</div>';
                }
                
                html += '</div>';
                
                // æ¸²æŸ“å­™è¾ˆ
                const hasGrandchildren = children.some(child => child.children && child.children.length > 0);
                if (hasGrandchildren) {
                    html += '<div class="tree-connector"></div>';
                    
                    for (const child of children) {
                        if (child.children && child.children.length > 0) {
                            html += await renderDescendants(child.children, generation + 1, compact);
                        }
                    }
                }
            }
            
            return html;
        }

        // æ¸²æŸ“æ ‘èŠ‚ç‚¹
        function renderTreeNode(individual, nodeClass, label, compact = false) {
            const compactClass = compact ? ' compact' : '';
            const birthYear = individual.birth_date ? new Date(individual.birth_date).getFullYear() : '';
            const deathYear = individual.death_date ? new Date(individual.death_date).getFullYear() : '';
            const lifeSpan = birthYear ? (deathYear ? `${birthYear}-${deathYear}` : `${birthYear}-`) : '';
            
            return `
                <div class="tree-node ${nodeClass}${compactClass}" data-id="${individual.individual_id}" onclick="selectNode(${individual.individual_id})" oncontextmenu="showContextMenu(event, ${individual.individual_id})">
                    <div class="node-name">${individual.full_name}</div>
                    ${!compact ? `
                        <div class="node-details">${individual.gender === 'male' ? 'â™‚' : 'â™€'} ${label}</div>
                        ${lifeSpan ? `<div class="node-details">${lifeSpan}</div>` : ''}
                        ${individual.occupation ? `<div class="node-occupation">${individual.occupation}</div>` : ''}
                    ` : ''}
                </div>
            `;
        }

        // æ¸²æŸ“å¸¦è¿æ¥çº¿çš„æ ‘èŠ‚ç‚¹
        function renderTreeNodeWithConnection(individual, nodeClass, label, connectionColor, motherName, compact = false) {
            const compactClass = compact ? ' compact' : '';
            const birthYear = individual.birth_date ? new Date(individual.birth_date).getFullYear() : '';
            const deathYear = individual.death_date ? new Date(individual.death_date).getFullYear() : '';
            const lifeSpan = birthYear ? (deathYear ? `${birthYear}-${deathYear}` : `${birthYear}-`) : '';
            
            return `
                <div class="tree-node ${nodeClass}${compactClass}" data-id="${individual.individual_id}" onclick="selectNode(${individual.individual_id})" oncontextmenu="showContextMenu(event, ${individual.individual_id})" style="border-left: 4px solid ${connectionColor};">
                    <div class="node-name">${individual.full_name}</div>
                    ${!compact ? `
                        <div class="node-details">${individual.gender === 'male' ? 'â™‚' : 'â™€'} ${label}</div>
                        ${lifeSpan ? `<div class="node-details">${lifeSpan}</div>` : ''}
                        ${individual.occupation ? `<div class="node-occupation">${individual.occupation}</div>` : ''}
                        ${motherName ? `<div class="mother-info" style="color: ${connectionColor};">æ¯: ${motherName}</div>` : ''}
                    ` : `
                        ${motherName ? `<div class="mother-info" style="color: ${connectionColor}; font-size: 0.6em;">æ¯: ${motherName}</div>` : ''}
                    `}
                </div>
            `;
        }

        // é€‰æ‹©èŠ‚ç‚¹
        function selectNode(nodeId) {
            selectedNodeId = nodeId;
            // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
            if (currentRootId) {
                showFamilyTree(currentRootId);
            }
        }

        // æ˜¾ç¤ºå³é”®èœå•
        function showContextMenu(event, nodeElement) {
            const nodeId = parseInt(nodeElement.dataset.id);
            contextMenuNode = nodeId;
            selectedNodeId = nodeId;
            
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        // æ›´æ”¹æ˜¾ç¤ºä»£æ•°
        function changeGenerations() {
            currentGenerations = parseInt(document.getElementById('generationSelect').value);
            if (currentRootId) {
                showFamilyTree(currentRootId);
            }
        }

        // æ›´æ–°æ ‘å¤´éƒ¨ä¿¡æ¯
        function updateTreeHeader(individual) {
            document.getElementById('currentRootName').textContent = individual.full_name + ' çš„å®¶æ—æ ‘';
            document.getElementById('currentGenInfo').textContent = `æ˜¾ç¤º${currentGenerations}ä»£å…³ç³»`;
        }

        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'æ·»åŠ æ—é•¿';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = '';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').style.display = 'block';
        }

        // æ˜¾ç¤ºæ·»åŠ å­å¥³æ¨¡æ€æ¡†
        async function showAddChildModal() {
            if (!contextMenuNode) return;
            
            document.getElementById('modalTitle').textContent = 'æ·»åŠ å­å¥³';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'child';
            document.getElementById('memberForm').reset();
            
            // è·å–çˆ¶æ¯ä¿¡æ¯
            const parentMember = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!parentMember) return;
            
            // å¦‚æœæ˜¯ç”·æ€§ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªå¦»å­
            if (parentMember.gender === 'male') {
                try {
                    const spousesResponse = await fetch(`/api/v1/individuals/${contextMenuNode}/spouses`);
                    const spousesData = await spousesResponse.json();
                    
                    if (spousesData.success && spousesData.data) {
                        const wives = spousesData.data.filter(spouse => spouse.gender === 'female');
                        
                        // æ˜¾ç¤ºæˆ–éšè—æ¯äº²é€‰æ‹©ç»„
                        const wifeSelectionGroup = document.getElementById('wifeSelectionGroup');
                        const selectedWife = document.getElementById('selectedWife');
                        
                        if (wives.length > 1) {
                            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……é€‰é¡¹
                            selectedWife.innerHTML = '<option value="">è¯·é€‰æ‹©æ¯äº²</option>';
                            wives.forEach(wife => {
                                const option = document.createElement('option');
                                option.value = wife.individual_id;
                                const wifeOrder = wife.marriage_order || 1;
                                option.textContent = `${wife.full_name} (ç¬¬${wifeOrder}ä»»å¦»å­)`;
                                selectedWife.appendChild(option);
                            });
                            wifeSelectionGroup.style.display = 'block';
                        } else if (wives.length === 1) {
                            // åªæœ‰ä¸€ä¸ªå¦»å­ï¼Œè‡ªåŠ¨é€‰æ‹©
                            selectedWife.value = wives[0].individual_id;
                            wifeSelectionGroup.style.display = 'none';
                        } else {
                            wifeSelectionGroup.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('è·å–é…å¶ä¿¡æ¯å¤±è´¥:', error);
                }
            } else {
                // å¦‚æœæ˜¯å¥³æ€§ï¼Œéšè—æ¯äº²é€‰æ‹©ç»„
                document.getElementById('wifeSelectionGroup').style.display = 'none';
            }
            
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // æ˜¾ç¤ºæ·»åŠ é…å¶æ¨¡æ€æ¡†
        function showAddSpouseModal() {
            if (!contextMenuNode) return;
            
            document.getElementById('modalTitle').textContent = 'æ·»åŠ é…å¶';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'spouse';
            document.getElementById('memberForm').reset();
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // æ˜¾ç¤ºæ·»åŠ çˆ¶äº²æ¨¡æ€æ¡†
        function showAddFatherModal() {
            if (!contextMenuNode) return;
            
            const member = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!member) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰çˆ¶äº²
            if (member.father_id) {
                showNotification('è¯¥æˆå‘˜å·²æœ‰çˆ¶äº²ä¿¡æ¯', 'warning');
                document.getElementById('contextMenu').style.display = 'none';
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'æ·»åŠ çˆ¶äº²';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'father';
            document.getElementById('memberForm').reset();
            // é»˜è®¤è®¾ç½®ä¸ºç”·æ€§
            document.getElementById('gender').value = 'male';
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // æ˜¾ç¤ºæ·»åŠ æ¯äº²æ¨¡æ€æ¡†
        function showAddMotherModal() {
            if (!contextMenuNode) return;
            
            const member = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!member) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ¯äº²
            if (member.mother_id) {
                showNotification('è¯¥æˆå‘˜å·²æœ‰æ¯äº²ä¿¡æ¯', 'warning');
                document.getElementById('contextMenu').style.display = 'none';
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'æ·»åŠ æ¯äº²';
            document.getElementById('editingId').value = '';
            document.getElementById('parentType').value = 'mother';
            document.getElementById('memberForm').reset();
            // é»˜è®¤è®¾ç½®ä¸ºå¥³æ€§
            document.getElementById('gender').value = 'female';
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡†
        function showViewDetailsModal() {
            if (!contextMenuNode) return;
            
            const member = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!member) return;
            
            const content = `
                <div style="line-height: 1.8;">
                    <p><strong>å§“åï¼š</strong>${member.full_name}</p>
                    <p><strong>æ€§åˆ«ï¼š</strong>${member.gender === 'male' ? 'ç”·' : 'å¥³'}</p>
                    <p><strong>å‡ºç”Ÿæ—¥æœŸï¼š</strong>${member.birth_date ? formatDate(member.birth_date) : 'æœªçŸ¥'}</p>
                    ${member.birth_place ? '<p><strong>å‡ºç”Ÿåœ°ç‚¹ï¼š</strong>' + member.birth_place + '</p>' : ''}
                    ${member.death_date ? '<p><strong>å»ä¸–æ—¥æœŸï¼š</strong>' + formatDate(member.death_date) + '</p>' : ''}
                    ${member.burial_place || member.death_place ? '<p><strong>åŸ‹è‘¬åœ°ç‚¹ï¼š</strong>' + (member.burial_place || member.death_place) + '</p>' : ''}
                    <p><strong>èŒä¸šï¼š</strong>${member.occupation || 'æœªå¡«å†™'}</p>
                    <p><strong>å¤‡æ³¨ï¼š</strong>${member.notes || 'æ— '}</p>
                </div>
            `;
            
            document.getElementById('detailsContent').innerHTML = content;
            document.getElementById('detailsModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // ç¼–è¾‘é€‰ä¸­æˆå‘˜
        function editSelectedMember() {
            if (!contextMenuNode) return;
            
            const member = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!member) return;
            
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æˆå‘˜ä¿¡æ¯';
            document.getElementById('editingId').value = member.individual_id;
            document.getElementById('fullName').value = member.full_name;
            document.getElementById('gender').value = member.gender;
            document.getElementById('birthDate').value = member.birth_date ? member.birth_date.split('T')[0] : '';
            document.getElementById('birthPlace').value = member.birth_place || '';
            document.getElementById('deathDate').value = member.death_date ? member.death_date.split('T')[0] : '';
            document.getElementById('burialPlace').value = member.burial_place || member.death_place || '';
            document.getElementById('occupation').value = member.occupation || '';
            document.getElementById('notes').value = member.notes || '';
            
            document.getElementById('memberModal').style.display = 'block';
            document.getElementById('contextMenu').style.display = 'none';
        }

        // åˆ é™¤é€‰ä¸­æˆå‘˜
        async function deleteSelectedMember() {
            if (!contextMenuNode) return;
            
            const member = allMembers.find(m => m.individual_id === contextMenuNode);
            if (!member) return;
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${member.full_name} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/individuals/${contextMenuNode}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('åˆ é™¤æˆåŠŸ', 'success');
                    await loadAllMembers();
                    if (currentRootId === contextMenuNode) {
                        currentRootId = null;
                        document.getElementById('treeContainer').innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸŒ±</div>
                                <div class="empty-state-text">é€‰æ‹©ä¸€ä¸ªæˆå‘˜æŸ¥çœ‹å®¶æ—æ ‘</div>
                            </div>
                        `;
                    } else if (currentRootId) {
                        showFamilyTree(currentRootId);
                    }
                } else {
                    showNotification(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                showNotification('ç½‘ç»œé”™è¯¯', 'error');
            }
            
            document.getElementById('contextMenu').style.display = 'none';
        }

        // å¤„ç†è¡¨å•æäº¤
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = getFormData();
            const editingId = document.getElementById('editingId').value;
            const parentType = document.getElementById('parentType').value;
            
            try {
                let response;
                
                if (editingId) {
                    // æ›´æ–°ç°æœ‰æˆå‘˜
                    response = await fetch(`/api/v1/individuals/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // åˆ›å»ºæ–°æˆå‘˜
                    if (parentType === 'spouse' && contextMenuNode) {
                        // å…ˆåˆ›å»ºé…å¶æˆå‘˜
                        const createResponse = await fetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // åˆ›å»ºé…å¶å…³ç³»
                            const spouseResponse = await fetch(`/api/v1/individuals/${contextMenuNode}/add-spouse`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    spouse_id: createData.data.individual_id
                                })
                            });
                            
                            const spouseData = await spouseResponse.json();
                            
                            if (spouseData.success) {
                                showNotification('é…å¶æ·»åŠ æˆåŠŸ', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(spouseData.message || 'é…å¶å…³ç³»åˆ›å»ºå¤±è´¥', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'é…å¶åˆ›å»ºå¤±è´¥', 'error');
                            return;
                        }
                    } else if (parentType === 'child' && contextMenuNode) {
                        // è®¾ç½®çˆ¶æ¯ID
                        const parentMember = allMembers.find(m => m.individual_id === contextMenuNode);
                        console.log('æ·»åŠ å­å¥³ - çˆ¶æ¯æˆå‘˜:', parentMember);
                        
                        if (parentMember.gender === 'male') {
                            formData.father_id = contextMenuNode;
                            
                            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†ç‰¹å®šçš„å¦»å­
                            const selectedWifeId = document.getElementById('selectedWife').value;
                            if (selectedWifeId) {
                                formData.mother_id = parseInt(selectedWifeId);
                                console.log('æ·»åŠ å­å¥³ - é€‰æ‹©çš„æ¯äº²ID:', selectedWifeId);
                            } else {
                                // å¦‚æœæ²¡æœ‰é€‰æ‹©ï¼Œå°è¯•è‡ªåŠ¨è®¾ç½®ï¼ˆå…¼å®¹å•å¦»å­æƒ…å†µï¼‰
                                const spousesResponse = await fetch(`/api/v1/individuals/${contextMenuNode}/spouses`);
                                const spousesData = await spousesResponse.json();
                                const spouses = spousesData.success ? spousesData.data : [];
                                
                                const wives = spouses.filter(spouse => spouse.gender === 'female');
                                if (wives.length === 1) {
                                    formData.mother_id = wives[0].individual_id;
                                } else if (wives.length > 1) {
                                    showNotification('è¯·é€‰æ‹©å­©å­çš„æ¯äº²', 'warning');
                                    return;
                                }
                            }
                        } else if (parentMember.gender === 'female') {
                            formData.mother_id = contextMenuNode;
                            // å¦‚æœæ¯äº²æœ‰é…å¶ï¼Œè‡ªåŠ¨è®¾ç½®çˆ¶äº²
                            const spousesResponse = await fetch(`/api/v1/individuals/${contextMenuNode}/spouses`);
                            const spousesData = await spousesResponse.json();
                            const spouses = spousesData.success ? spousesData.data : [];
                            
                            const husbands = spouses.filter(spouse => spouse.gender === 'male');
                            if (husbands.length > 0) {
                                // å¦‚æœæœ‰å¤šä¸ªä¸ˆå¤«ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆåœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦ç”¨æˆ·é€‰æ‹©ï¼‰
                                formData.father_id = husbands[0].individual_id;
                            }
                        }
                        
                        console.log('æ·»åŠ å­å¥³ - æœ€ç»ˆè¡¨å•æ•°æ®:', formData);
                    } else if (parentType === 'father' && contextMenuNode) {
                        // æ·»åŠ çˆ¶äº²ï¼šåˆ›å»ºçˆ¶äº²åæ›´æ–°å­å¥³çš„father_id
                        console.log('æ·»åŠ çˆ¶äº² - å­å¥³ID:', contextMenuNode);
                        
                        // å…ˆåˆ›å»ºçˆ¶äº²
                        const createResponse = await fetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // æ›´æ–°å­å¥³çš„father_id
                            const childMember = allMembers.find(m => m.individual_id === contextMenuNode);
                            const updateData = {
                                ...childMember,
                                father_id: createData.data.individual_id
                            };
                            
                            const updateResponse = await fetch(`/api/v1/individuals/${contextMenuNode}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });
                            
                            const updateResult = await updateResponse.json();
                            
                            if (updateResult.success) {
                                showNotification('çˆ¶äº²æ·»åŠ æˆåŠŸ', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(updateResult.message || 'æ›´æ–°çˆ¶å­å…³ç³»å¤±è´¥', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'çˆ¶äº²åˆ›å»ºå¤±è´¥', 'error');
                            return;
                        }
                    } else if (parentType === 'mother' && contextMenuNode) {
                        // æ·»åŠ æ¯äº²ï¼šåˆ›å»ºæ¯äº²åæ›´æ–°å­å¥³çš„mother_id
                        console.log('æ·»åŠ æ¯äº² - å­å¥³ID:', contextMenuNode);
                        
                        // å…ˆåˆ›å»ºæ¯äº²
                        const createResponse = await fetch('/api/v1/individuals', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(formData)
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.success) {
                            // æ›´æ–°å­å¥³çš„mother_id
                            const childMember = allMembers.find(m => m.individual_id === contextMenuNode);
                            const updateData = {
                                ...childMember,
                                mother_id: createData.data.individual_id
                            };
                            
                            const updateResponse = await fetch(`/api/v1/individuals/${contextMenuNode}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(updateData)
                            });
                            
                            const updateResult = await updateResponse.json();
                            
                            if (updateResult.success) {
                                showNotification('æ¯äº²æ·»åŠ æˆåŠŸ', 'success');
                                closeMemberModal();
                                await loadAllMembers();
                                showFamilyTree(currentRootId || contextMenuNode);
                                return;
                            } else {
                                showNotification(updateResult.message || 'æ›´æ–°æ¯å­å…³ç³»å¤±è´¥', 'error');
                                return;
                            }
                        } else {
                            showNotification(createData.message || 'æ¯äº²åˆ›å»ºå¤±è´¥', 'error');
                            return;
                        }
                    }
                    
                    response = await fetch('/api/v1/individuals', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(editingId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
                    closeMemberModal();
                    await loadAllMembers();
                    
                    if (!currentRootId) {
                        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œè®¾ä¸ºæ ¹èŠ‚ç‚¹
                        showFamilyTree(data.data.individual_id);
                    } else {
                        // åˆ·æ–°å½“å‰æ ‘
                        showFamilyTree(currentRootId);
                    }
                } else {
                    showNotification(data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è¡¨å•æäº¤é”™è¯¯:', error);
                showNotification('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
            }
        }

        // è·å–è¡¨å•æ•°æ®
        function getFormData() {
            const data = {
                full_name: document.getElementById('fullName').value,
                gender: document.getElementById('gender').value,
                occupation: document.getElementById('occupation').value || null,
                notes: document.getElementById('notes').value || null
            };
            
            const birthDate = document.getElementById('birthDate').value;
            if (birthDate) data.birth_date = birthDate + 'T00:00:00Z';
            
            const birthPlace = document.getElementById('birthPlace').value;
            if (birthPlace) data.birth_place = birthPlace;
            
            const deathDate = document.getElementById('deathDate').value;
            if (deathDate) data.death_date = deathDate + 'T00:00:00Z';
            
            const burialPlace = document.getElementById('burialPlace').value;
            if (burialPlace) {
                data.burial_place = burialPlace;
                data.death_place = burialPlace; // å…¼å®¹æ€§
            }
            
            return data;
        }

        // å…³é—­æˆå‘˜æ¨¡æ€æ¡†
        function closeMemberModal() {
            document.getElementById('memberModal').style.display = 'none';
        }

        // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.getFullYear() + 'å¹´' + (date.getMonth() + 1) + 'æœˆ' + date.getDate() + 'æ—¥';
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ¸²æŸ“ä¼ ç»Ÿæ—è°±å¸ƒå±€
        async function renderTraditionalFamilyLayout(rootData) {
            if (!rootData || !rootData.individual) {
                return '<div class="empty-state"><div class="empty-state-icon">ğŸŒ±</div><div class="empty-state-text">æš‚æ— æ•°æ®</div></div>';
            }
            
            let html = '<div class="traditional-family-layout">';
            
            // æ¸²æŸ“çˆ¶æ¯å±‚
            html += '<div class="parents-row">';
            html += renderTreeNode(rootData.individual, 'root-node', 'æœ¬äºº', false);
            
            if (rootData.spouses && rootData.spouses.length > 0) {
                rootData.spouses.forEach((spouse, index) => {
                    const wifeOrder = spouse.marriage_order || (index + 1);
                    let spouseLabel = 'é…å¶';
                    
                    if (rootData.individual.gender === 'male' && spouse.gender === 'female') {
                        spouseLabel = rootData.spouses.length > 1 ? `${spouse.full_name}` : 'å¦»å­';
                    } else if (rootData.individual.gender === 'female' && spouse.gender === 'male') {
                        spouseLabel = 'ä¸ˆå¤«';
                    }
                    
                    html += '<div class="spouse-separator">|</div>';
                    html += renderTreeNode(spouse, 'spouse-node', spouseLabel, false);
                });
            }
            html += '</div>';
            
            // å¦‚æœæœ‰å­å¥³ï¼Œæ¸²æŸ“å­å¥³å±‚
            if (rootData.children && rootData.children.length > 0) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå¦»åˆ¶æƒ…å†µ
                const wives = rootData.spouses ? rootData.spouses.filter(s => s.gender === 'female') : [];
                const shouldGroupByWife = wives.length > 1;
                
                if (shouldGroupByWife) {
                    html += await renderChildrenGroupedByWife(rootData, wives);
                } else {
                    html += await renderChildrenTraditionalLayout(rootData.children);
                }
            }
            
            html += '</div>';
            return html;
        }

        // æŒ‰å¦»å­åˆ†ç»„æ¸²æŸ“å­å¥³ï¼ˆä¼ ç»Ÿå¸ƒå±€ï¼‰
        async function renderChildrenGroupedByWife(rootData, wives) {
            let html = '<div class="wives-groups-layout">';
            
            try {
                // è·å–å®¶åº­å…³ç³»æ•°æ®
                const familiesResponse = await fetch(`/api/v1/families/husband/${rootData.individual.individual_id}`);
                const familiesData = await familiesResponse.json();
                const families = familiesData.success ? familiesData.data : [];
                
                // ä¸ºæ¯ä¸ªå¦»å­åˆ›å»ºä¸€ä¸ªç»„
                for (const wife of wives) {
                    const family = families.find(f => f.wife_id === wife.individual_id);
                    const wifeOrder = family ? family.marriage_order : 1;
                    const wifeChildren = rootData.children.filter(child => child.individual.mother_id === wife.individual_id);
                    
                    if (wifeChildren.length > 0) {
                        const wifeColor = getWifeColor(wife.individual_id, wives);
                        
                        html += `<div class="wife-group" style="border-color: ${wifeColor};">`;
                        html += `<div class="wife-group-header" style="border-color: ${wifeColor}; color: ${wifeColor};">`;
                        html += `${wife.full_name}ï¼ˆç¬¬${wifeOrder}ä»»å¦»å­ï¼‰æ‰€ç”Ÿå­å¥³`;
                        html += '</div>';
                        
                        html += '<div class="wife-children-traditional">';
                        html += await renderChildrenTraditionalLayout(wifeChildren, wifeColor);
                        html += '</div>';
                        
                        html += '</div>';
                    }
                }
                
            } catch (error) {
                console.error('è·å–å®¶åº­å…³ç³»å¤±è´¥:', error);
                html += await renderChildrenTraditionalLayout(rootData.children);
            }
            
            html += '</div>';
            return html;
        }

        // æ¸²æŸ“ä¼ ç»Ÿå¸ƒå±€çš„å­å¥³
        async function renderChildrenTraditionalLayout(children, groupColor = '#4CAF50') {
            if (!children || children.length === 0) {
                return '';
            }
            
            let html = '<div class="children-connection-area">';
            
            // ä¸»å‚ç›´è¿æ¥çº¿
            html += '<div class="main-vertical-line"></div>';
            
            // æ°´å¹³è¿æ¥çº¿ï¼ˆå¦‚æœæœ‰å¤šä¸ªå­å¥³ï¼‰
            if (children.length > 1) {
                html += `<div class="horizontal-connector" style="background: ${groupColor}; width: ${Math.min(children.length * 180, 800)}px;"></div>`;
            }
            
            // å­å¥³èŠ‚ç‚¹
            html += '<div class="children-with-lines">';
            
            // æŒ‰å‡ºç”Ÿé¡ºåºæ’åº
            const sortedChildren = [...children].sort((a, b) => {
                const aDate = a.individual.birth_date ? new Date(a.individual.birth_date) : new Date(0);
                const bDate = b.individual.birth_date ? new Date(b.individual.birth_date) : new Date(0);
                return aDate - bDate;
            });
            
            for (let i = 0; i < sortedChildren.length; i++) {
                const child = sortedChildren[i];
                const orderLabels = ['é•¿', 'æ¬¡', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
                const orderLabel = i < orderLabels.length ? orderLabels[i] : `ç¬¬${i + 1}`;
                const genderSuffix = child.individual.gender === 'male' ? 'å­' : 'å¥³';
                
                html += '<div class="child-with-line">';
                
                // å‚ç›´è¿æ¥çº¿
                if (children.length > 1) {
                    html += `<div class="child-vertical-line" style="background: ${groupColor};"></div>`;
                }
                
                // æ’åºæ ‡ç­¾
                html += `<div class="child-order-label">${orderLabel}${genderSuffix}</div>`;
                
                // å­å¥³èŠ‚ç‚¹
                html += '<div class="family-group">';
                html += renderTreeNode(child.individual, 'child-node', `${orderLabel}${genderSuffix}`, false);
                
                // è·å–å­å¥³çš„é…å¶
                try {
                    const spousesResponse = await fetch(`/api/v1/individuals/${child.individual.individual_id}/spouses`);
                    const spousesData = await spousesResponse.json();
                    
                    if (spousesData.success && spousesData.data && spousesData.data.length > 0) {
                        spousesData.data.forEach(spouse => {
                            html += '<div class="marriage-connector">ğŸ’•</div>';
                            html += renderTreeNode(spouse, 'child-node spouse-node', 'é…å¶', false);
                        });
                    }
                } catch (error) {
                    console.error('è·å–å­å¥³é…å¶ä¿¡æ¯å¤±è´¥:', error);
                }
                
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            html += '</div>';
            
            return html;
        }

        // è·å–å¦»å­å¯¹åº”çš„é¢œè‰²
        function getWifeColor(wifeId, wives) {
            const colors = ['#ff6b9d', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#fd79a8', '#00b894'];
            const index = wives.findIndex(w => w.individual_id === wifeId);
            return colors[index % colors.length];
        }
    </script>
</body>
</html> 